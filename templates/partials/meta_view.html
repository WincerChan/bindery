{% set rating = book.rating %}
{% set detail_url = "/book/" ~ book_id ~ return_to_query %}
{% set edit_url = "/book/" ~ book_id ~ "/edit" ~ return_to_query %}
{% set preview_url = "/book/" ~ book_id ~ "/preview" ~ return_to_query %}
<div id="meta-panel" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
  <div class="flex flex-col lg:flex-row gap-6">
    <div class="w-[180px] shrink-0">
      <div class="w-[180px] aspect-[2/3] rounded-xl overflow-hidden border border-slate-200 bg-slate-100 shadow-sm">
        {% if book.cover_url %}
          <img src="{{ book.cover_url }}" alt="{{ book.title }}" class="w-full h-full object-cover" />
        {% else %}
          <div class="w-full h-full flex flex-col items-center justify-center text-slate-400 p-5 text-center">
            <div class="w-10 h-10 bg-slate-200 rounded-lg flex items-center justify-center text-slate-500 font-bold text-lg mb-2">B</div>
            <span class="text-xs font-mono line-clamp-2">{{ book.title }}</span>
          </div>
        {% endif %}
      </div>

      <div class="mt-3 grid gap-2">
        <a
          class="w-full inline-flex items-center justify-center px-3 py-2 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          href="/book/{{ book_id }}/download"
        >下载 EPUB</a>
        <form action="/book/{{ book_id }}/read" method="post">
          <input type="hidden" name="read" value="{{ '0' if book.read else '1' }}" />
          <input type="hidden" name="next" value="{{ detail_url }}" />
          <button
            class="w-full inline-flex items-center justify-center px-3 py-2 text-sm bg-white border border-emerald-200 text-emerald-700 hover:bg-emerald-50 rounded-lg font-medium transition-colors cursor-pointer"
            type="submit"
          >{{ "标记未读" if book.read else "标记已读" }}</button>
        </form>
        <a
          class="w-full inline-flex items-center justify-center px-3 py-2 text-sm bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-lg font-medium transition-colors"
          href="{{ preview_url }}"
        >打开阅读器</a>
        <form action="/book/{{ book_id }}/archive" method="post">
          <input type="hidden" name="next" value="{{ return_to }}" />
          <button
            class="w-full inline-flex items-center justify-center px-3 py-2 text-sm bg-white border border-red-200 text-red-600 hover:bg-red-50 rounded-lg font-medium transition-colors cursor-pointer"
            type="submit"
          >归档</button>
        </form>
      </div>
    </div>

    <div class="min-w-0 flex-1">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div class="min-w-0">
          <h2 class="text-xl font-bold text-slate-900 truncate">{{ book.title }}</h2>
          <div class="mt-2 flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-slate-600">
            <span class="font-medium text-slate-800 truncate">{{ book.author or "未知" }}</span>
            {% if book.language %}
              <span class="text-slate-300">·</span>
              <span class="truncate">{{ book.language }}</span>
            {% endif %}
          </div>
        </div>
    <a
      class="px-4 py-2 text-sm bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 font-medium transition-colors"
      href="{{ edit_url }}"
      hx-get="{{ edit_url }}"
      hx-target="#meta-panel"
      hx-swap="outerHTML"
    >编辑</a>
      </div>

      <div class="mt-4 flex flex-wrap gap-3 text-xs text-slate-600">
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">系列</span>
          <span class="truncate text-slate-700">{{ book.series or "—" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">出版社</span>
          <span class="truncate text-slate-700">{{ book.publisher or "—" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">标签</span>
          <span class="truncate text-slate-700">{{ book.tags | join(", ") if book.tags else "—" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">发表时间</span>
          <span class="truncate text-slate-700 font-mono">{{ (book.published or "—")[:10] }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">ISBN</span>
          <span class="truncate text-slate-700 font-mono">{{ book.isbn or "—" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">来源</span>
          <span class="truncate text-slate-700">{{ "EPUB" if book.source_type == "epub" else "TXT" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">规则模板</span>
          <span class="truncate text-slate-700 font-mono">{{ book.rule_template or "—" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">状态</span>
          <span class="truncate text-slate-700">{{ book.status_label }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">阅读状态</span>
          <span class="truncate {{ 'text-emerald-700' if book.read else 'text-slate-700' }}">{{ "已读" if book.read else "未读" }}</span>
        </div>
        <div class="flex items-center gap-2 min-w-[180px] flex-1">
          <span class="shrink-0 text-slate-500 font-semibold uppercase">星级</span>
          <span class="text-amber-500 truncate">
            {% if rating is not none %}
              {{ "★" * rating }}<span class="text-slate-300">{{ "☆" * (5 - rating) }}</span>
            {% else %}
              <span class="text-slate-500">未评分</span>
            {% endif %}
          </span>
        </div>
        {% if book.description %}
          <div class="w-full pt-3 border-t border-slate-100">
            <div class="text-xs font-semibold text-slate-500 uppercase">简介</div>
            <p class="mt-2 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">{{ book.description }}</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
