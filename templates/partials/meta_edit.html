<div id="meta-panel" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
  {% set detail_url = "/book/" ~ book_id ~ return_to_query %}
  <form
    id="meta-edit-form"
    action="/book/{{ book_id }}/edit"
    method="post"
    enctype="multipart/form-data"
    hx-post="/book/{{ book_id }}/edit"
    hx-target="#meta-panel"
    hx-swap="outerHTML"
    hx-encoding="multipart/form-data"
    class="space-y-6"
  >
    <input type="hidden" name="return_to" value="{{ return_to }}" />
    {% if error %}
      <div class="rounded-lg border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm">
        {{ error }}
      </div>
    {% endif %}
    {% if info %}
      <div class="rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 px-3 py-2 text-sm">
        {{ info }}
      </div>
    {% endif %}
    {% if lookup_sources and lookup_sources|length > 1 %}
      <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600 flex flex-wrap items-center gap-2">
        <span>可选来源：</span>
        {% for item in lookup_sources %}
          <button
            type="button"
            data-apply-source="{{ item.id }}"
            data-source-label="{{ item.label }}"
            class="px-2 py-1 rounded border border-slate-300 bg-white hover:bg-slate-100 transition-colors cursor-pointer {% if item.selected == 'true' %}border-indigo-300 text-indigo-700 bg-indigo-50{% endif %}"
          >{{ item.label }}{% if item.selected == 'true' %}（已应用）{% endif %}</button>
        {% endfor %}
      </div>
    {% endif %}
    <input type="hidden" name="metadata_source" data-metadata-source value="{{ lookup_selected_source or '' }}" />
    <script type="application/json" id="lookup-changed-fields">{{ lookup_changed_fields | default([], true) | tojson }}</script>
    <script type="application/json" id="lookup-candidates-data">{{ lookup_candidates | default({}, true) | tojson }}</script>
    <input type="hidden" data-lookup-allow-cover-fill value="{{ 'true' if lookup_allow_cover_fill else 'false' }}" />

    <div class="flex flex-col lg:flex-row gap-6">
      <div class="w-[180px] shrink-0">
        <div class="w-[180px] aspect-[2/3] rounded-xl overflow-hidden border border-slate-200 bg-slate-100 shadow-sm">
          {% if book.cover_url %}
            <img src="{{ book.cover_url }}" alt="{{ book.title }}" class="w-full h-full object-cover" />
          {% else %}
            <div class="w-full h-full flex flex-col items-center justify-center text-slate-400 p-5 text-center">
              <div class="w-10 h-10 bg-slate-200 rounded-lg flex items-center justify-center text-slate-500 font-bold text-lg mb-2">B</div>
              <span class="text-xs font-mono line-clamp-2">{{ book.title }}</span>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="min-w-0 flex-1 space-y-6">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div class="min-w-0">
            <h2 class="text-xl font-bold text-slate-900 truncate">{{ book.title }}</h2>
            <div class="mt-1 text-xs text-slate-500">编辑并写回到 EPUB（可选：同时写回封面）</div>
            <div class="mt-2 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-slate-500">
              <span class="truncate">{{ book.author or "未知" }}</span>
              <span class="text-slate-300">·</span>
              <span class="truncate">{{ book.language }}</span>
              {% if book.series %}
                <span class="text-slate-300">·</span>
                <span class="truncate">{{ book.series }}</span>
              {% endif %}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <a class="px-4 py-2 text-sm bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-colors" href="{{ detail_url }}">取消</a>
            <button
              type="button"
              data-fetch-metadata
              hx-post="/book/{{ book_id }}/metadata/fetch"
              hx-target="#meta-panel"
              hx-swap="outerHTML"
              hx-include="#meta-edit-form"
              class="px-4 py-2 text-sm bg-white border border-indigo-200 text-indigo-700 rounded-lg hover:bg-indigo-50 font-medium transition-colors cursor-pointer"
            >自动填充信息</button>
            <button class="px-4 py-2 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-sm transition-colors cursor-pointer" type="submit">保存并写回</button>
          </div>
        </div>
        <div data-fetch-status class="hidden text-xs text-indigo-600">正在从 Amazon / 豆瓣检索，请稍候...</div>

        <div class="flex flex-wrap gap-4">
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">书名</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-sm text-slate-900 bg-white"
              contenteditable="true"
              data-edit-field="title"
              data-autofill-target="title"
              data-singleline="true"
              role="textbox"
              aria-label="书名"
              spellcheck="false"
            >{{ book.title }}</div>
            <input type="hidden" name="title" data-edit-target="title" value="{{ book.title }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">作者</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white"
              contenteditable="true"
              data-edit-field="author"
              data-autofill-target="author"
              data-singleline="true"
              role="textbox"
              aria-label="作者"
              spellcheck="false"
            >{{ book.author or "" }}</div>
            <input type="hidden" name="author" data-edit-target="author" value="{{ book.author or '' }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">语言</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white"
              contenteditable="true"
              data-edit-field="language"
              data-autofill-target="language"
              data-singleline="true"
              role="textbox"
              aria-label="语言"
              spellcheck="false"
            >{{ book.language }}</div>
            <input type="hidden" name="language" data-edit-target="language" value="{{ book.language }}" />
          </div>
          <div class="space-y-1 min-w-[180px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">星级</label>
            <div class="flex items-center gap-1">
              {% for i in range(1, 6) %}
                <button
                  type="button"
                  data-rating-star="{{ i }}"
                  class="text-lg text-slate-300 hover:text-amber-400 transition-colors cursor-pointer"
                  aria-label="{{ i }} 星"
                >★</button>
              {% endfor %}
              <span class="ml-2 text-xs text-slate-500" data-rating-label>未评分</span>
            </div>
            <input type="hidden" name="rating" data-rating-input value="{{ book.rating if book.rating is not none else '' }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">系列</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white"
              contenteditable="true"
              data-edit-field="series"
              data-singleline="true"
              role="textbox"
              aria-label="系列"
              spellcheck="false"
            >{{ book.series or "" }}</div>
            <input type="hidden" name="series" data-edit-target="series" value="{{ book.series or '' }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">出版社</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white"
              contenteditable="true"
              data-edit-field="publisher"
              data-autofill-target="publisher"
              data-singleline="true"
              role="textbox"
              aria-label="出版社"
              spellcheck="false"
            >{{ book.publisher or "" }}</div>
            <input type="hidden" name="publisher" data-edit-target="publisher" value="{{ book.publisher or '' }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">标签</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white"
              contenteditable="true"
              data-edit-field="tags"
              data-autofill-target="tags"
              data-singleline="true"
              role="textbox"
              aria-label="标签（逗号分隔）"
              spellcheck="false"
            >{{ book.tags | join(", ") if book.tags else "" }}</div>
            <input type="hidden" name="tags" data-edit-target="tags" value="{{ book.tags | join(', ') if book.tags else '' }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">发表时间</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white"
              contenteditable="true"
              data-edit-field="published"
              data-autofill-target="published"
              data-singleline="true"
              role="textbox"
              aria-label="发表时间"
              spellcheck="false"
            >{{ book.published[:10] if book.published else "" }}</div>
            <input type="hidden" name="published" data-edit-target="published" value="{{ book.published[:10] if book.published else '' }}" />
          </div>
          <div class="space-y-1 min-w-[220px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">ISBN</label>
            <div
              class="min-h-[38px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm text-slate-700 bg-white font-mono"
              contenteditable="true"
              data-edit-field="isbn"
              data-autofill-target="isbn"
              data-singleline="true"
              role="textbox"
              aria-label="ISBN"
              spellcheck="false"
            >{{ book.isbn or "" }}</div>
            <input type="hidden" name="isbn" data-edit-target="isbn" value="{{ book.isbn or '' }}" />
          </div>
          <div class="space-y-1 min-w-[280px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">封面 <span class="normal-case font-medium text-slate-400">(本地上传)</span></label>
            <input
              class="w-full text-sm text-slate-700 border border-slate-300 rounded-lg file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none"
              type="file"
              name="cover_file"
              accept="image/*"
            />
            <p class="text-[11px] text-slate-500">可选：与 URL 二选一；上传后会写入 EPUB 本体。</p>
          </div>
          <div class="space-y-1 min-w-[280px] flex-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">封面 <span class="normal-case font-medium text-slate-400">(URL 下载)</span></label>
            <input
              class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"
              type="url"
              name="cover_url"
              data-autofill-target="cover_url"
              placeholder="https://example.com/cover.jpg"
              value="{{ book.cover_fetch_url or '' }}"
            />
            <p class="text-[11px] text-slate-500">可选：保存时会下载并写回到 EPUB。</p>
          </div>
          <div class="space-y-1 w-full">
            <label class="text-xs font-semibold text-slate-500 uppercase">内容简介</label>
            <div
              class="min-h-[120px] w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm leading-relaxed text-slate-700 bg-white whitespace-pre-wrap"
              contenteditable="true"
              data-edit-field="description"
              data-autofill-target="description"
              data-multiline="true"
              role="textbox"
              aria-label="内容简介"
              spellcheck="false"
            >{{ book.description or "" }}</div>
            <textarea name="description" data-edit-target="description" class="hidden">{{ book.description or '' }}</textarea>
          </div>
        </div>

        <div class="pt-5 border-t border-slate-100 space-y-4">
          <div>
            <h3 class="text-sm font-semibold text-slate-900">构建设置</h3>
            <p class="text-xs text-slate-500 mt-1">解析规则影响重新生成；渲染主题与自定义 CSS 会写回到 EPUB。</p>
          </div>

          <div class="grid lg:grid-cols-2 gap-6">
            {% if book.can_regenerate %}
              <div class="space-y-1">
                <label class="text-xs font-semibold text-slate-500 uppercase">切章规则 <span class="normal-case font-medium text-slate-400">(仅 TXT)</span></label>
                <select name="rule_template" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none bg-white text-sm">
                  {% for rule in rules %}
                    <option value="{{ rule.rule_id }}" {% if book.rule_template == rule.rule_id %}selected{% endif %}>
                      {{ rule.name }} · v{{ rule.version }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <input type="hidden" name="rule_template" value="{{ book.rule_template or '' }}" />
            {% endif %}

            <div class="space-y-1">
              <label class="text-xs font-semibold text-slate-500 uppercase">渲染主题</label>
              <select name="theme_template" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none bg-white text-sm">
                <option value="__book__" {% if book.source_type == "epub" and book.theme_template == "__book__" %}selected{% endif %}>保持书籍样式（仅 EPUB）</option>
                {% for theme in themes %}
                  <option value="{{ theme.theme_id }}" {% if book.effective_theme_template == theme.theme_id %}selected{% endif %}>
                    {{ theme.name }} · v{{ theme.version }}
                  </option>
                {% endfor %}
              </select>
              <p class="text-[11px] text-slate-500">会作为最后一层 CSS 追加（用于字体/边距等统一化）。</p>
            </div>
            <div class="space-y-2 border border-slate-200 rounded-xl p-4 bg-slate-50/30">
              <div class="flex items-center justify-between gap-2">
                <div class="text-sm font-medium text-slate-700">高级：针对本书追加 CSS</div>
                <button
                  type="button"
                  class="text-xs font-medium text-slate-500 hover:text-slate-700 transition-colors cursor-pointer"
                  data-format-target="book-custom-css"
                >格式化</button>
              </div>
              <div class="text-xs text-slate-500">这段 CSS 会追加在主题之后，优先生效。</div>
              <textarea
                id="book-custom-css"
                name="custom_css"
                rows="8"
                class="w-full p-3 font-mono text-xs border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"
                placeholder="/* 例如：body { font-family: 'Noto Serif SC'; } */"
              >{{ book.custom_css or '' }}</textarea>
            </div>
          </div>
        </div>

      </div>
    </div>
  </form>

  <script>
    (function () {
      const form = document.getElementById("meta-edit-form");
      if (!form) return;

      const fields = Array.from(form.querySelectorAll("[data-edit-field]"));
      const ratingInput = form.querySelector("[data-rating-input]");
      const ratingLabel = form.querySelector("[data-rating-label]");
      const ratingStars = Array.from(form.querySelectorAll("[data-rating-star]"));
      const formatButtons = Array.from(form.querySelectorAll("[data-format-target]"));
      const fetchButtons = Array.from(form.querySelectorAll("[data-fetch-metadata]"));
      const fetchStatus = form.querySelector("[data-fetch-status]");
      const metadataSourceInput = form.querySelector("[data-metadata-source]");
      const sourceButtons = Array.from(form.querySelectorAll("[data-apply-source]"));
      const autofillTargets = Array.from(form.querySelectorAll("[data-autofill-target]"));
      const changedFieldsScript = form.querySelector("#lookup-changed-fields");
      const candidatesScript = form.querySelector("#lookup-candidates-data");
      const allowCoverFillInput = form.querySelector("[data-lookup-allow-cover-fill]");
      const lookupCandidates = candidatesScript ? JSON.parse(candidatesScript.textContent || "{}") : {};
      const allowCoverFill = allowCoverFillInput ? allowCoverFillInput.value === "true" : false;

      const normalize = (value) => String(value || "").replace(/\u00a0/g, " ").replace(/\r\n/g, "\n");
      const indentUnit = "  ";

      function formatCssText(raw) {
        if (!raw) return "";
        let out = "";
        let indent = 0;
        let inString = null;
        let inComment = false;
        let escape = false;
        let pendingSpace = false;

        const pushIndent = () => {
          out += indentUnit.repeat(Math.max(0, indent));
        };

        const flushSpace = () => {
          if (pendingSpace && out && !out.endsWith(" ") && !out.endsWith("\n")) out += " ";
          pendingSpace = false;
        };

        for (let i = 0; i < raw.length; i += 1) {
          const ch = raw[i];
          const next = raw[i + 1];

          if (inComment) {
            out += ch;
            if (ch === "*" && next === "/") {
              out += "/";
              i += 1;
              inComment = false;
              out += "\n";
              pushIndent();
            }
            continue;
          }

          if (inString) {
            out += ch;
            if (escape) {
              escape = false;
            } else if (ch === "\\") {
              escape = true;
            } else if (ch === inString) {
              inString = null;
            }
            continue;
          }

          if (ch === '"' || ch === "'") {
            flushSpace();
            inString = ch;
            out += ch;
            continue;
          }

          if (ch === "/" && next === "*") {
            flushSpace();
            inComment = true;
            out += "/*";
            i += 1;
            continue;
          }

          if (/\s/.test(ch)) {
            pendingSpace = true;
            continue;
          }

          if (ch === "{") {
            out = out.trimEnd();
            out += " {\n";
            indent += 1;
            pushIndent();
            continue;
          }

          if (ch === "}") {
            out = out.trimEnd();
            indent = Math.max(0, indent - 1);
            out += "\n";
            pushIndent();
            out += "}";
            const rest = raw.slice(i + 1).trim();
            if (rest) {
              out += "\n";
              pushIndent();
            }
            continue;
          }

          if (ch === ";") {
            out = out.trimEnd();
            out += ";\n";
            pushIndent();
            continue;
          }

          flushSpace();
          out += ch;
        }

        return out.trim();
      }

      function syncField(fieldEl) {
        const key = fieldEl.dataset.editField;
        const target = form.querySelector(`[data-edit-target=\"${key}\"]`);
        if (!target) return;
        let value = normalize(fieldEl.innerText);
        if (fieldEl.dataset.multiline !== "true") {
          value = value.replace(/\n+/g, " ").trim();
        } else {
          value = value.trim();
        }
        target.value = value;
      }

      function setRating(value) {
        const numeric = value ? Number(value) : 0;
        if (ratingInput) ratingInput.value = numeric ? String(numeric) : "";
        ratingStars.forEach((star) => {
          const starValue = Number(star.dataset.ratingStar || 0);
          const active = numeric && starValue <= numeric;
          star.classList.toggle("text-amber-500", active);
          star.classList.toggle("text-slate-300", !active);
          star.setAttribute("aria-pressed", active ? "true" : "false");
        });
        if (ratingLabel) ratingLabel.textContent = numeric ? `${numeric} 星` : "未评分";
      }

      function setAutofillHighlight(fields) {
        const changed = new Set(Array.isArray(fields) ? fields : []);
        autofillTargets.forEach((target) => {
          const key = target.dataset.autofillTarget;
          const active = changed.has(key);
          target.classList.toggle("bg-amber-50", active);
          target.classList.toggle("ring-2", active);
          target.classList.toggle("ring-amber-300", active);
          target.classList.toggle("border-amber-300", active);
        });
      }

      function updateSourceButtons(selectedSource) {
        sourceButtons.forEach((btn) => {
          const source = (btn.dataset.applySource || "").trim();
          const label = btn.dataset.sourceLabel || source;
          const active = source && source === selectedSource;
          btn.classList.toggle("border-indigo-300", active);
          btn.classList.toggle("text-indigo-700", active);
          btn.classList.toggle("bg-indigo-50", active);
          btn.classList.toggle("border-slate-300", !active);
          btn.classList.toggle("bg-white", !active);
          btn.textContent = active ? `${label}（已应用）` : label;
        });
      }

      function setEditableValue(fieldKey, nextValue) {
        const fieldEl = form.querySelector(`[data-edit-field="${fieldKey}"]`);
        const target = form.querySelector(`[data-edit-target="${fieldKey}"]`);
        if (!fieldEl || !target) return false;
        const value = String(nextValue || "");
        const current = String(target.value || "");
        if (current === value) return false;
        fieldEl.innerText = value;
        syncField(fieldEl);
        return true;
      }

      function setInputValue(selector, nextValue) {
        const input = form.querySelector(selector);
        if (!input) return false;
        const value = String(nextValue || "");
        if (String(input.value || "") === value) return false;
        input.value = value;
        return true;
      }

      function applyLookupSource(source) {
        const candidate = lookupCandidates[source];
        if (!candidate) return;
        const changed = [];
        if (setEditableValue("title", candidate.title)) changed.push("title");
        if (setEditableValue("author", candidate.author)) changed.push("author");
        if (setEditableValue("language", candidate.language)) changed.push("language");
        if (setEditableValue("description", candidate.description)) changed.push("description");
        if (setEditableValue("publisher", candidate.publisher)) changed.push("publisher");
        if (setEditableValue("published", candidate.published)) changed.push("published");
        if (setEditableValue("isbn", candidate.isbn)) changed.push("isbn");
        const tagsValue = Array.isArray(candidate.tags) ? candidate.tags.join(", ") : "";
        if (setEditableValue("tags", tagsValue)) changed.push("tags");
        if (allowCoverFill && source === "douban" && candidate.cover_url) {
          const coverInput = form.querySelector('input[name="cover_url"]');
          if (coverInput && !String(coverInput.value || "").trim()) {
            if (setInputValue('input[name="cover_url"]', candidate.cover_url)) changed.push("cover_url");
          }
        }
        if (metadataSourceInput) metadataSourceInput.value = source;
        updateSourceButtons(source);
        setAutofillHighlight(changed);
      }

      fields.forEach((fieldEl) => {
        syncField(fieldEl);
        fieldEl.addEventListener("input", () => syncField(fieldEl));
        if (fieldEl.dataset.singleline === "true") {
          fieldEl.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
            }
          });
        }
      });

      if (ratingInput && ratingStars.length) {
        const initial = parseInt(ratingInput.value || "0", 10);
        setRating(initial || 0);
        ratingStars.forEach((star) => {
          star.addEventListener("click", () => {
            setRating(Number(star.dataset.ratingStar || 0));
          });
        });
      }

      formatButtons.forEach((btn) => {
        const targetId = btn.dataset.formatTarget;
        if (!targetId) return;
        const target = document.getElementById(targetId);
        if (!target) return;
        btn.addEventListener("click", () => {
          target.value = formatCssText(target.value);
        });
      });

      if (changedFieldsScript) {
        try {
          const changed = JSON.parse(changedFieldsScript.textContent || "[]");
          setAutofillHighlight(changed);
        } catch (_err) {
          setAutofillHighlight([]);
        }
      } else {
        setAutofillHighlight([]);
      }

      function setFetchPending(active) {
        fetchButtons.forEach((btn) => {
          const idleLabel = btn.dataset.idleLabel || btn.textContent.trim() || "自动填充信息";
          btn.dataset.idleLabel = idleLabel;
          btn.disabled = active;
          btn.textContent = active ? "请求中..." : idleLabel;
          btn.classList.toggle("opacity-70", active);
          btn.classList.toggle("cursor-not-allowed", active);
        });
        if (fetchStatus) {
          fetchStatus.classList.toggle("hidden", !active);
        }
      }

      fetchButtons.forEach((btn) => {
        const idleLabel = btn.textContent.trim() || "自动填充信息";
        btn.dataset.idleLabel = idleLabel;
        btn.addEventListener("click", () => {
          if (metadataSourceInput) {
            metadataSourceInput.value = "";
          }
          fields.forEach((fieldEl) => syncField(fieldEl));
          setFetchPending(true);
        });
        btn.addEventListener("htmx:afterRequest", () => setFetchPending(false));
        btn.addEventListener("htmx:responseError", () => setFetchPending(false));
        btn.addEventListener("htmx:sendError", () => setFetchPending(false));
      });

      sourceButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const source = (btn.dataset.applySource || "").trim();
          if (!source) return;
          applyLookupSource(source);
        });
      });

      if (metadataSourceInput && metadataSourceInput.value) {
        updateSourceButtons(metadataSourceInput.value);
      }

      form.addEventListener("submit", (event) => {
        fields.forEach((fieldEl) => syncField(fieldEl));
        const titleTarget = form.querySelector('[data-edit-target="title"]');
        if (titleTarget && !titleTarget.value.trim()) {
          event.preventDefault();
          const titleField = form.querySelector('[data-edit-field="title"]');
          if (titleField) {
            titleField.focus();
            titleField.classList.add("ring-2", "ring-red-400");
            setTimeout(() => titleField.classList.remove("ring-2", "ring-red-400"), 1500);
          }
        }
      });
    })();
  </script>
</div>
