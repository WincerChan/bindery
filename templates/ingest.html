{% extends "base.html" %}

{% block title %}Bindery · 入库{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    {% if error %}
      <div class="mb-4 rounded-lg border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm">
        {{ error }}
      </div>
    {% endif %}
    <form id="ingest-form" action="/ingest" method="post" enctype="multipart/form-data" class="space-y-6">
      <input type="hidden" name="dedupe_mode" value="keep" data-dedupe-mode />
      <div data-upload-tokens></div>
      <div
        data-dropzone
        class="relative border-2 border-dashed rounded-xl p-12 text-center transition-all border-slate-300 hover:border-indigo-400 bg-white [&.dragging]:border-indigo-500 [&.dragging]:bg-indigo-50"
      >
        <input
          type="file"
          name="files"
          accept=".txt,.epub"
          multiple
          required
          aria-label="上传 TXT/EPUB 文件"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center gap-4 pointer-events-none">
          <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
            <svg viewBox="0 0 24 24" fill="none" class="w-8 h-8" aria-hidden="true">
              <path d="M8 17l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M12 13v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.7A6 6 0 0 0 6 9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M6 9.5A4.5 4.5 0 0 0 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">拖拽 TXT/EPUB 文件到这里</h3>
            <p class="text-slate-500 mt-1 text-sm">TXT 会按规则切章生成 EPUB；EPUB 会直接入库（可选写回元数据）。</p>
          </div>
        </div>
      </div>
      <div data-file-feedback class="hidden rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600"></div>

      <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
        入库页不再编辑元数据与封面；请在入库后进入书籍详情页进行编辑并写回 EPUB。
      </div>

      <div class="pt-5 border-t border-slate-100 space-y-4">
        <div>
          <h3 class="text-sm font-semibold text-slate-900">构建设置</h3>
          <p class="text-xs text-slate-500 mt-1">默认继承全局主题，可为本书追加 CSS（会写回到 EPUB）。</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">切章规则 <span class="normal-case font-medium text-slate-400">(仅 TXT)</span></label>
            <select name="rule_template" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
              {% for rule in rules %}
                <option value="{{ rule.rule_id }}">{{ rule.name }} · v{{ rule.version }}</option>
              {% endfor %}
            </select>
            <p class="text-[11px] text-slate-500">用于 TXT 切章；EPUB 入库会忽略。</p>
          </div>

          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">渲染主题</label>
            <select
              name="theme_template"
              data-theme-select
              class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
            >
              {% for theme in themes %}
                <option value="{{ theme.theme_id }}" {% if theme.theme_id == "default" %}selected{% endif %}>{{ theme.name }} · v{{ theme.version }}</option>
              {% endfor %}
              <option value="__book__">保持书籍样式（仅 EPUB）</option>
            </select>
            <p class="text-[11px] text-slate-500">主题 CSS 会作为最后一层追加；本书 CSS 优先生效。</p>
          </div>
        </div>

        <details class="border border-slate-200 rounded-xl p-4 bg-slate-50/30">
          <summary class="cursor-pointer text-sm font-medium text-slate-700">高级：针对本批导入书籍追加 CSS</summary>
          <div class="mt-4 space-y-2">
            <div class="flex items-center justify-between gap-2">
              <div class="text-xs text-slate-500">这段 CSS 会追加在主题之后，优先生效。</div>
              <button
                type="button"
                class="text-xs font-medium text-slate-500 hover:text-slate-700 transition-colors cursor-pointer"
                data-format-target="ingest-custom-css"
              >格式化</button>
            </div>
            <textarea
              id="ingest-custom-css"
              name="custom_css"
              rows="8"
              class="w-full p-3 font-mono text-xs border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"
              placeholder="/* 例如：body { font-family: 'Noto Serif SC'; } */"
            >{{ custom_css or '' }}</textarea>
          </div>
        </details>
      </div>

      <div class="flex flex-wrap gap-2">
        <button
          data-ingest-preview
          class="px-4 py-2 text-sm font-medium bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors cursor-pointer"
          type="button"
          hx-post="/ingest/preview"
          hx-target="#ingest-preview"
          hx-include="#ingest-form"
          hx-encoding="multipart/form-data"
        >
          预览解析
        </button>
        <button data-ingest-submit class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors cursor-pointer" type="submit">开始入库</button>
      </div>
      <div data-ingest-error class="hidden rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700"></div>
      <div data-ingest-preview-status class="hidden text-xs text-indigo-600">正在解析文件，请稍候...</div>
      <div data-ingest-status class="hidden text-xs text-indigo-600">正在提交入库任务，请稍候...</div>
    </form>

    <div id="ingest-preview" class="mt-4 bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-sm text-slate-500 text-center py-6">选择文件后点击“预览解析”，查看 TOC 与章节统计。</div>
    </div>
  </section>
</div>

<script>
  const ingestForm = document.getElementById('ingest-form');
  const fileInput = ingestForm ? ingestForm.querySelector('input[name="files"]') : null;
  const fileFeedback = ingestForm ? ingestForm.querySelector('[data-file-feedback]') : null;
  const ingestPreviewBtn = ingestForm ? ingestForm.querySelector('[data-ingest-preview]') : null;
  const ingestSubmitBtn = ingestForm ? ingestForm.querySelector('[data-ingest-submit]') : null;
  const ingestError = ingestForm ? ingestForm.querySelector('[data-ingest-error]') : null;
  const ingestPreviewStatus = ingestForm ? ingestForm.querySelector('[data-ingest-preview-status]') : null;
  const ingestStatus = ingestForm ? ingestForm.querySelector('[data-ingest-status]') : null;
  const dedupeModeInput = ingestForm ? ingestForm.querySelector('[data-dedupe-mode]') : null;
  const uploadTokensContainer = ingestForm ? ingestForm.querySelector('[data-upload-tokens]') : null;
  const themeSelect = ingestForm ? ingestForm.querySelector('[data-theme-select]') : null;
  const KEEP_BOOK_THEME_VALUE = '__book__';
  const DEFAULT_THEME_VALUE = 'default';

  document.querySelectorAll('[data-dropzone]').forEach((dropzone) => {
    dropzone.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropzone.classList.add('dragging');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragging'));
    dropzone.addEventListener('drop', () => dropzone.classList.remove('dragging'));
  });

  const formatCssText = (raw) => {
    if (!raw) return '';
    let out = '';
    let indent = 0;
    let inString = null;
    let inComment = false;
    let escape = false;
    let pendingSpace = false;
    const indentUnit = '  ';
    const pushIndent = () => {
      out += indentUnit.repeat(Math.max(0, indent));
    };
    const flushSpace = () => {
      if (pendingSpace && out && !out.endsWith(' ') && !out.endsWith('\n')) out += ' ';
      pendingSpace = false;
    };
    for (let i = 0; i < raw.length; i += 1) {
      const ch = raw[i];
      const next = raw[i + 1];
      if (inComment) {
        out += ch;
        if (ch === '*' && next === '/') {
          out += '/';
          i += 1;
          inComment = false;
          out += '\n';
          pushIndent();
        }
        continue;
      }
      if (inString) {
        out += ch;
        if (escape) {
          escape = false;
        } else if (ch === '\\') {
          escape = true;
        } else if (ch === inString) {
          inString = null;
        }
        continue;
      }
      if (ch === '"' || ch === "'") {
        flushSpace();
        inString = ch;
        out += ch;
        continue;
      }
      if (ch === '/' && next === '*') {
        flushSpace();
        inComment = true;
        out += '/*';
        i += 1;
        continue;
      }
      if (/\s/.test(ch)) {
        pendingSpace = true;
        continue;
      }
      if (ch === '{') {
        out = out.trimEnd();
        out += ' {\n';
        indent += 1;
        pushIndent();
        continue;
      }
      if (ch === '}') {
        out = out.trimEnd();
        indent = Math.max(0, indent - 1);
        out += '\n';
        pushIndent();
        out += '}';
        const rest = raw.slice(i + 1).trim();
        if (rest) {
          out += '\n';
          pushIndent();
        }
        continue;
      }
      if (ch === ';') {
        out = out.trimEnd();
        out += ';\n';
        pushIndent();
        continue;
      }
      flushSpace();
      out += ch;
    }
    return out.trim();
  };

  document.querySelectorAll('[data-format-target]').forEach((btn) => {
    const targetId = btn.dataset.formatTarget;
    if (!targetId) return;
    const target = document.getElementById(targetId);
    if (!target) return;
    btn.addEventListener('click', () => {
      target.value = formatCssText(target.value);
    });
  });

  const setSelectedFilesFeedback = () => {
    if (!fileInput || !fileFeedback) return;
    const files = Array.from(fileInput.files || []);
    if (!files.length) {
      fileFeedback.classList.add('hidden');
      fileFeedback.textContent = '';
      return;
    }
    const names = files.map((f) => f.name).join('、');
    fileFeedback.textContent = files.length === 1 ? `已选择：${names}` : `已选择 ${files.length} 个文件：${names}`;
    fileFeedback.classList.remove('hidden');
  };

  const autoSelectThemeByFiles = () => {
    if (!fileInput || !themeSelect) return;
    const files = Array.from(fileInput.files || []);
    if (!files.length) return;
    let hasTxt = false;
    let hasEpub = false;
    files.forEach((file) => {
      const name = String(file.name || '').toLowerCase();
      if (name.endsWith('.txt')) hasTxt = true;
      if (name.endsWith('.epub')) hasEpub = true;
    });
    if (hasEpub && !hasTxt) {
      themeSelect.value = KEEP_BOOK_THEME_VALUE;
      return;
    }
    themeSelect.value = DEFAULT_THEME_VALUE;
  };

  const selectedFileCount = () => {
    if (!fileInput) return 0;
    return Array.from(fileInput.files || []).length;
  };

  const setPreviewLoading = (loading) => {
    if (!ingestPreviewBtn) return;
    if (loading) {
      ingestPreviewBtn.disabled = true;
      ingestPreviewBtn.textContent = '解析中...';
      ingestPreviewBtn.classList.add('opacity-70', 'cursor-not-allowed');
      if (ingestPreviewStatus) {
        const count = selectedFileCount();
        ingestPreviewStatus.textContent = count > 0
          ? `正在解析 ${count} 个文件，请稍候...`
          : '正在解析文件，请稍候...';
        ingestPreviewStatus.classList.remove('hidden');
      }
      return;
    }
    ingestPreviewBtn.disabled = false;
    ingestPreviewBtn.textContent = '预览解析';
    ingestPreviewBtn.classList.remove('opacity-70', 'cursor-not-allowed');
    if (ingestPreviewStatus) ingestPreviewStatus.classList.add('hidden');
  };

  const hideIngestError = () => {
    if (!ingestError) return;
    ingestError.classList.add('hidden');
    ingestError.textContent = '';
  };

  const showIngestError = (message) => {
    if (!ingestError) return;
    ingestError.textContent = message;
    ingestError.classList.remove('hidden');
  };

  const clearUploadTokens = () => {
    if (!uploadTokensContainer) return;
    uploadTokensContainer.innerHTML = '';
  };

  const syncUploadTokensFromPreview = () => {
    if (!uploadTokensContainer) return 0;
    uploadTokensContainer.innerHTML = '';
    const previewContainer = document.getElementById('ingest-preview');
    if (!previewContainer) return 0;
    const tokens = Array.from(previewContainer.querySelectorAll('[data-upload-token]'))
      .map((node) => (node.dataset.uploadToken || '').trim())
      .filter((token, index, list) => token && list.indexOf(token) === index);
    tokens.forEach((token) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'upload_tokens';
      input.value = token;
      uploadTokensContainer.appendChild(input);
    });
    return tokens.length;
  };

  if (fileInput) {
    fileInput.addEventListener('change', () => {
      clearUploadTokens();
      fileInput.disabled = false;
      fileInput.required = true;
      setSelectedFilesFeedback();
      autoSelectThemeByFiles();
      if (ingestPreviewBtn) ingestPreviewBtn.click();
    });
  }

  if (ingestPreviewBtn) {
    ingestPreviewBtn.addEventListener('htmx:beforeRequest', () => {
      hideIngestError();
      setPreviewLoading(true);
    });
    ingestPreviewBtn.addEventListener('htmx:afterRequest', (event) => {
      setPreviewLoading(false);
      if (event.detail && event.detail.successful) {
        hideIngestError();
        syncUploadTokensFromPreview();
      }
    });
    ingestPreviewBtn.addEventListener('htmx:responseError', (event) => {
      setPreviewLoading(false);
      clearUploadTokens();
      const status = event.detail && event.detail.xhr ? event.detail.xhr.status : 0;
      if (status === 413) {
        showIngestError('预览请求过大（413）：请减少单次文件数，或先压缩/拆分后再预览。');
        return;
      }
      const suffix = status ? `（HTTP ${status}）` : '';
      showIngestError(`预览解析失败${suffix}，请稍后重试。`);
    });
  }

  if (ingestForm && ingestSubmitBtn) {
    ingestForm.addEventListener('submit', () => {
      const tokenCount = syncUploadTokensFromPreview();
      if (fileInput) {
        if (tokenCount > 0) {
          fileInput.required = false;
          fileInput.disabled = true;
        } else {
          fileInput.required = true;
          fileInput.disabled = false;
        }
      }
      if (dedupeModeInput) dedupeModeInput.value = 'keep';
      const hasDuplicateHit = Boolean(document.querySelector('#ingest-preview [data-duplicate-hit="1"]'));
      if (hasDuplicateHit && dedupeModeInput) {
        const shouldNormalize = window.confirm(
          '检测到疑似重复书籍。\n点击“确定”将归一到已入库书籍并跳过重复入库；点击“取消”将继续新建。'
        );
        dedupeModeInput.value = shouldNormalize ? 'normalize' : 'keep';
      }
      ingestSubmitBtn.disabled = true;
      ingestSubmitBtn.textContent = '入库中...';
      ingestSubmitBtn.classList.add('opacity-70', 'cursor-not-allowed');
      if (ingestStatus) {
        const count = selectedFileCount();
        ingestStatus.textContent = count > 0
          ? `正在提交 ${count} 个文件的入库任务，请稍候...`
          : '正在提交入库任务，请稍候...';
        ingestStatus.classList.remove('hidden');
      }
    });
  }
</script>
{% endblock %}
