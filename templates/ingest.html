{% extends "base.html" %}

{% block title %}Bindery · 入库{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Ingest</h1>
        <p class="text-sm text-slate-500 mt-1">拖拽导入 TXT/EPUB，转换前预览 TOC，并写入元数据。</p>
      </div>
      <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200 text-xs font-medium text-slate-600">
        <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
        转换后进入书库
      </div>
    </div>
  </section>

  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <div class="flex items-end justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-bold text-slate-900">TXT → EPUB</h2>
        <p class="text-sm text-slate-500 mt-1">按规则切章并生成 EPUB（含元数据写回）。</p>
      </div>
    </div>

    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="space-y-6">
      <div
        data-dropzone
        class="relative border-2 border-dashed rounded-xl p-12 text-center transition-all border-slate-300 hover:border-indigo-400 bg-white [&.dragging]:border-indigo-500 [&.dragging]:bg-indigo-50"
      >
        <input
          type="file"
          name="files"
          accept=".txt"
          multiple
          required
          aria-label="上传 TXT 文件"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center gap-4 pointer-events-none">
          <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
            <svg viewBox="0 0 24 24" fill="none" class="w-8 h-8" aria-hidden="true">
              <path d="M8 17l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M12 13v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.7A6 6 0 0 0 6 9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M6 9.5A4.5 4.5 0 0 0 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">拖拽 TXT 文件到这里</h3>
            <p class="text-slate-500 mt-1 text-sm">或点击浏览本地文件（支持多选）</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">规则模板</label>
          <select name="rule_template" class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
            {% for rule in rules %}
              <option value="{{ rule.rule_id }}">{{ rule.name }} · v{{ rule.version }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">语言</label>
          <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="language" value="zh-CN" />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">星级</label>
          <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="number" name="rating" min="0" max="5" step="1" />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">封面（可选）</label>
          <input class="w-full text-sm text-slate-700 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" type="file" name="cover_file" accept="image/*" />
        </div>
      </div>

      <details class="border border-slate-200 rounded-xl p-4 bg-slate-50/30">
        <summary class="cursor-pointer text-sm font-medium text-slate-700">更多元数据</summary>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">书名</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="title" placeholder="留空则自动解析" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">作者</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="author" placeholder="留空则自动解析" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">系列</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="series" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">Identifier</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="identifier" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">出版社</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="publisher" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">标签</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="tags" placeholder="例如：科幻, 太空歌剧" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">发表时间</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="published" placeholder="例如：2024-08-01" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">ISBN</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="isbn" />
          </div>
        </div>
        <div class="mt-4 space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">内容简介</label>
          <textarea class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" name="description" rows="3"></textarea>
        </div>
      </details>

      <div class="flex flex-wrap gap-2">
        <button
          class="px-4 py-2 text-sm font-medium bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors"
          type="button"
          hx-post="/upload/preview"
          hx-target="#upload-preview"
          hx-include="#upload-form"
          hx-encoding="multipart/form-data"
        >
          预览解析
        </button>
        <button class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors" type="submit">开始转换</button>
      </div>
    </form>

    <div id="upload-preview" class="mt-4 bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-sm text-slate-500 text-center py-6">上传后点击“预览解析”查看 TOC 与章节统计。</div>
    </div>
  </section>

  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <div class="flex items-end justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-bold text-slate-900">导入 EPUB</h2>
        <p class="text-sm text-slate-500 mt-1">已有 EPUB 直接入库（不会重新转换），可覆盖元数据与封面。</p>
      </div>
    </div>

    <form id="epub-upload-form" action="/upload/epub" method="post" enctype="multipart/form-data" class="space-y-6">
      <div
        data-dropzone
        class="relative border-2 border-dashed rounded-xl p-12 text-center transition-all border-slate-300 hover:border-indigo-400 bg-white [&.dragging]:border-indigo-500 [&.dragging]:bg-indigo-50"
      >
        <input
          type="file"
          name="files"
          accept=".epub"
          multiple
          required
          aria-label="上传 EPUB 文件"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center gap-4 pointer-events-none">
          <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
            <svg viewBox="0 0 24 24" fill="none" class="w-8 h-8" aria-hidden="true">
              <path d="M8 17l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M12 13v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.7A6 6 0 0 0 6 9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M6 9.5A4.5 4.5 0 0 0 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">拖拽 EPUB 文件到这里</h3>
            <p class="text-slate-500 mt-1 text-sm">或点击浏览本地文件（支持多选）</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">语言</label>
          <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="language" value="" placeholder="留空则沿用 EPUB" />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">星级</label>
          <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="number" name="rating" min="0" max="5" step="1" />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">封面（可选）</label>
          <input class="w-full text-sm text-slate-700 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" type="file" name="cover_file" accept="image/*" />
        </div>
      </div>

      <details class="border border-slate-200 rounded-xl p-4 bg-slate-50/30">
        <summary class="cursor-pointer text-sm font-medium text-slate-700">覆盖元数据</summary>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">书名</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="title" placeholder="留空则沿用 EPUB" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">作者</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="author" placeholder="留空则沿用 EPUB" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">系列</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="series" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">Identifier</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="identifier" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">出版社</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="publisher" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">标签</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="tags" placeholder="例如：科幻, 太空歌剧" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">发表时间</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="published" placeholder="例如：2024-08-01" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">ISBN</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="isbn" />
          </div>
        </div>
        <div class="mt-4 space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">内容简介</label>
          <textarea class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" name="description" rows="3"></textarea>
        </div>
      </details>

      <div class="flex flex-wrap gap-2">
        <button
          class="px-4 py-2 text-sm font-medium bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors"
          type="button"
          hx-post="/upload/epub/preview"
          hx-target="#upload-preview-epub"
          hx-include="#epub-upload-form"
          hx-encoding="multipart/form-data"
        >
          预览解析
        </button>
        <button class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors" type="submit">开始入库</button>
      </div>
    </form>

    <div id="upload-preview-epub" class="mt-4 bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-sm text-slate-500 text-center py-6">上传后点击“预览解析”查看 TOC 与章节统计。</div>
    </div>
  </section>
</div>

<script>
  document.querySelectorAll('[data-dropzone]').forEach((dropzone) => {
    const fileInput = dropzone.querySelector('input[type="file"]');
    if (!fileInput) return;
    dropzone.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropzone.classList.add('dragging');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragging'));
    dropzone.addEventListener('drop', (event) => {
      event.preventDefault();
      dropzone.classList.remove('dragging');
      if (event.dataTransfer.files.length) {
        fileInput.files = event.dataTransfer.files;
      }
    });
  });
</script>
{% endblock %}

