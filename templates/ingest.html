{% extends "base.html" %}

{% block title %}Bindery · 入库{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8">
  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">入库</h1>
        <p class="text-sm text-slate-500 mt-1">一个上传框：支持 TXT/EPUB；系统自动判定并执行转换/导入。</p>
      </div>
      <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200 text-xs font-medium text-slate-600">
        <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
        转换后进入书库
      </div>
    </div>
  </section>

  <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
    <form id="ingest-form" action="/ingest" method="post" enctype="multipart/form-data" class="space-y-6">
      <div
        data-dropzone
        class="relative border-2 border-dashed rounded-xl p-12 text-center transition-all border-slate-300 hover:border-indigo-400 bg-white [&.dragging]:border-indigo-500 [&.dragging]:bg-indigo-50"
      >
        <input
          type="file"
          name="files"
          accept=".txt,.epub"
          multiple
          required
          aria-label="上传 TXT/EPUB 文件"
          class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div class="flex flex-col items-center gap-4 pointer-events-none">
          <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
            <svg viewBox="0 0 24 24" fill="none" class="w-8 h-8" aria-hidden="true">
              <path d="M8 17l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M12 13v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.7A6 6 0 0 0 6 9.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M6 9.5A4.5 4.5 0 0 0 4 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">拖拽 TXT/EPUB 文件到这里</h3>
            <p class="text-slate-500 mt-1 text-sm">TXT 会按规则切章生成 EPUB；EPUB 会直接入库（可选写回元数据）。</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">语言</label>
          <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="language" value="" placeholder="留空自动" />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">星级</label>
          <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="number" name="rating" min="0" max="5" step="1" />
        </div>
        <div class="space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">封面（可选）</label>
          <input class="w-full text-sm text-slate-700 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" type="file" name="cover_file" accept="image/*" />
        </div>
      </div>

      <details class="border border-slate-200 rounded-xl p-4 bg-slate-50/30">
        <summary class="cursor-pointer text-sm font-medium text-slate-700">覆盖元数据（可选）</summary>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">书名</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="title" placeholder="留空则自动/沿用" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">作者</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="author" placeholder="留空则自动/沿用" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">系列</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="series" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">出版社</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="publisher" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">标签</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="tags" placeholder="例如：科幻, 太空歌剧" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">发表时间</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="date" name="published" />
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">ISBN</label>
            <input class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" type="text" name="isbn" />
          </div>
        </div>
        <div class="mt-4 space-y-1">
          <label class="text-xs font-semibold text-slate-500 uppercase">内容简介</label>
          <textarea class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" name="description" rows="3"></textarea>
        </div>
      </details>

      <div class="pt-5 border-t border-slate-100 space-y-4">
        <div>
          <h3 class="text-sm font-semibold text-slate-900">构建设置</h3>
          <p class="text-xs text-slate-500 mt-1">默认继承全局主题，可为本书追加 CSS（会写回到 EPUB）。</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">切章规则 <span class="normal-case font-medium text-slate-400">(仅 TXT)</span></label>
            <select name="rule_template" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
              {% for rule in rules %}
                <option value="{{ rule.rule_id }}">{{ rule.name }} · v{{ rule.version }}</option>
              {% endfor %}
            </select>
            <p class="text-[11px] text-slate-500">用于 TXT 切章；EPUB 入库会忽略。</p>
          </div>

          <div class="space-y-1">
            <label class="text-xs font-semibold text-slate-500 uppercase">渲染主题</label>
            <select name="theme_template" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
              <option value="">保持书籍样式（EPUB） / 默认（TXT）</option>
              {% for theme in themes %}
                <option value="{{ theme.theme_id }}">{{ theme.name }} · v{{ theme.version }}</option>
              {% endfor %}
            </select>
            <p class="text-[11px] text-slate-500">主题 CSS 会作为最后一层追加；本书 CSS 优先生效。</p>
          </div>
        </div>

        <details class="border border-slate-200 rounded-xl p-4 bg-slate-50/30">
          <summary class="cursor-pointer text-sm font-medium text-slate-700">高级：针对本书追加 CSS</summary>
          <div class="mt-4 space-y-2">
            <div class="text-xs text-slate-500">这段 CSS 会追加在主题之后，优先生效。</div>
            <textarea
              name="custom_css"
              rows="8"
              class="w-full p-3 font-mono text-xs border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none"
              placeholder="/* 例如：body { font-family: 'Noto Serif SC'; } */"
            ></textarea>
          </div>
        </details>
      </div>

      <div class="flex flex-wrap gap-2">
        <button
          class="px-4 py-2 text-sm font-medium bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors"
          type="button"
          hx-post="/ingest/preview"
          hx-target="#ingest-preview"
          hx-include="#ingest-form"
          hx-encoding="multipart/form-data"
        >
          预览解析
        </button>
        <button class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors" type="submit">开始入库</button>
      </div>
    </form>

    <div id="ingest-preview" class="mt-4 bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-sm text-slate-500 text-center py-6">选择文件后点击“预览解析”，查看 TOC 与章节统计。</div>
    </div>
  </section>
</div>

<script>
  document.querySelectorAll('[data-dropzone]').forEach((dropzone) => {
    dropzone.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropzone.classList.add('dragging');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragging'));
    dropzone.addEventListener('drop', () => dropzone.classList.remove('dragging'));
  });
</script>
{% endblock %}
