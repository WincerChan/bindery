<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Bindery{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
    <link rel="shortcut icon" href="/static/logo.svg" />
    <link rel="stylesheet" href="/static/app.css" />
    <style>
      [x-cloak] { display: none !important; }
    </style>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-900">
    {% set path = request.url.path %}
    {% set nav_base = "flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors" %}
    {% set hide_nav = hide_nav if hide_nav is defined else false %}
    {% set main_class = main_class if main_class is defined and main_class else "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" %}
    {% if not hide_nav %}
    <nav class="sticky top-0 z-20 bg-white border-b border-slate-200 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-6">
          <a href="/" class="flex items-center gap-2 font-bold text-xl">
            <img src="/static/logo.svg" alt="Bindery logo" class="w-9 h-9 rounded-lg" />
            <span class="tracking-tight text-slate-900">Bindery</span>
          </a>
          <div class="hidden md:flex items-center gap-1">
            <a
              class="{{ nav_base }} {% if path == '/' or path.startswith('/book') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
              href="/"
            >书库</a>
            <a
              class="{{ nav_base }} {% if path.startswith('/ingest') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
              href="/ingest"
            >入库</a>
            <a
              class="{{ nav_base }} {% if path.startswith('/jobs') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
              href="/jobs"
            >任务</a>
            <a
              class="{{ nav_base }} {% if path.startswith('/tracker') or path.startswith('/wishlist') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
              href="/tracker"
            >追踪</a>
            <a
              class="{{ nav_base }} {% if path.startswith('/rules') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
              href="/rules"
            >规则</a>
            <a
              class="{{ nav_base }} {% if path.startswith('/archive') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
              href="/archive"
            >归档</a>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full border border-slate-200 text-xs font-medium text-slate-600">
            <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
            本地书库
          </div>
          <form action="/logout" method="post">
            <button
              type="submit"
              class="px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-red-500 hover:bg-slate-50 transition-colors cursor-pointer"
            >退出</button>
          </form>
        </div>
      </div>

      <div class="md:hidden border-t border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-2 flex flex-wrap gap-1">
          <a
            class="{{ nav_base }} {% if path == '/' or path.startswith('/book') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
            href="/"
          >书库</a>
          <a
            class="{{ nav_base }} {% if path.startswith('/ingest') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
            href="/ingest"
          >入库</a>
          <a
            class="{{ nav_base }} {% if path.startswith('/jobs') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
            href="/jobs"
          >任务</a>
          <a
            class="{{ nav_base }} {% if path.startswith('/tracker') or path.startswith('/wishlist') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
            href="/tracker"
          >追踪</a>
          <a
            class="{{ nav_base }} {% if path.startswith('/rules') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
            href="/rules"
          >规则</a>
          <a
            class="{{ nav_base }} {% if path.startswith('/archive') %}bg-indigo-50 text-indigo-700{% else %}text-slate-500 hover:text-slate-900 hover:bg-slate-50{% endif %}"
            href="/archive"
          >归档</a>
        </div>
      </div>
    </nav>
    {% endif %}

    <main class="{{ main_class }}">
      {% block content %}{% endblock %}
    </main>
    <div id="bindery-toast" class="fixed top-5 right-5 z-50 hidden max-w-sm">
      <div
        data-toast-body
        class="rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 px-3 py-2 text-sm shadow-sm"
      ></div>
    </div>
    <script>
      (() => {
        const toastRoot = document.getElementById('bindery-toast');
        if (!(toastRoot instanceof HTMLElement)) return;
        const toastBody = toastRoot.querySelector('[data-toast-body]');
        if (!(toastBody instanceof HTMLElement)) return;
        let hideTimer = null;

        const applyToastKind = (kind) => {
          const normalized = String(kind || 'success').trim().toLowerCase();
          toastBody.classList.remove(
            'border-emerald-200', 'bg-emerald-50', 'text-emerald-700',
            'border-amber-200', 'bg-amber-50', 'text-amber-700',
            'border-red-200', 'bg-red-50', 'text-red-700'
          );
          if (normalized === 'error') {
            toastBody.classList.add('border-red-200', 'bg-red-50', 'text-red-700');
            return;
          }
          if (normalized === 'warning') {
            toastBody.classList.add('border-amber-200', 'bg-amber-50', 'text-amber-700');
            return;
          }
          toastBody.classList.add('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
        };

        const showToast = (message, kind = 'success') => {
          const text = String(message || '').trim();
          if (!text) return;
          applyToastKind(kind);
          toastBody.textContent = text;
          toastRoot.classList.remove('hidden');
          if (hideTimer !== null) clearTimeout(hideTimer);
          hideTimer = setTimeout(() => {
            toastRoot.classList.add('hidden');
          }, 2600);
        };

        window.binderyToast = showToast;
        document.body.addEventListener('bindery:toast', (event) => {
          const detail = event && typeof event.detail === 'object' ? event.detail : {};
          const payload = detail && typeof detail.value === 'object' ? detail.value : detail;
          const message = payload && typeof payload.message === 'string' ? payload.message : '';
          const kind = payload && typeof payload.kind === 'string' ? payload.kind : 'success';
          showToast(message, kind);
        });

        const url = new URL(window.location.href);
        const toastMessage = url.searchParams.get('toast');
        if (toastMessage) {
          const toastKind = url.searchParams.get('toast_kind') || 'success';
          showToast(toastMessage, toastKind);
          url.searchParams.delete('toast');
          url.searchParams.delete('toast_kind');
          const nextUrl = `${url.pathname}${url.search}${url.hash}`;
          window.history.replaceState({}, '', nextUrl);
        }
      })();
    </script>
  </body>
</html>
