{% extends "base.html" %}

{% block title %}Bindery · 书库{% endblock %}

{% block content %}
<div class="space-y-6">
  <div
    id="library-controls"
    class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200"
  >
    <div class="relative w-full md:w-96">
      <svg viewBox="0 0 24 24" fill="none" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" aria-hidden="true">
        <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"></path>
        <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
      </svg>
      <input
        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
        type="search"
        name="q"
        placeholder="搜索标题、作者…"
        value="{{ q }}"
        hx-get="/library"
        hx-target="#library-section"
        hx-trigger="keyup changed delay:400ms"
        hx-include="#library-controls"
        hx-vals='{"page":"1"}'
      />
    </div>

    <div class="flex items-center gap-3 w-full md:w-auto">
      <select
        class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none"
        name="sort"
        hx-get="/library"
        hx-target="#library-section"
        hx-trigger="change"
        hx-include="#library-controls"
        hx-vals='{"page":"1"}'
      >
        <option value="created" {% if sort == 'created' %}selected{% endif %}>最近导入</option>
        <option value="updated" {% if sort == 'updated' %}selected{% endif %}>最近修改</option>
      </select>
      <input type="hidden" name="read_filter" value="{{ read_filter }}" />
      <a
        href="/?sort={{ sort }}&q={{ q|urlencode }}&read_filter={{ 'all' if read_filter == 'unread' else 'unread' }}&per_page={{ per_page }}"
        data-read-filter-toggle
        class="h-9 px-3 inline-flex items-center justify-center rounded-lg border text-sm font-medium transition-colors cursor-pointer {{ 'border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100' if read_filter == 'unread' else 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50' }}"
      >{{ '未读过滤：开' if read_filter == 'unread' else '仅看未读' }}</a>
      <input type="hidden" name="page" value="{{ page }}" data-page-input />
      <input type="hidden" name="per_page" value="{{ per_page }}" data-per-page-input />

      <div class="hidden md:flex bg-slate-100 p-1 rounded-lg border border-slate-200" data-view-toggle>
        <button
          type="button"
          class="toggle-btn p-1.5 rounded text-slate-500 hover:text-slate-700 transition-colors cursor-pointer [&.active]:bg-white [&.active]:shadow-sm [&.active]:text-indigo-600"
          data-view="grid"
          aria-label="封面墙"
          title="封面墙"
        >
          <svg viewBox="0 0 24 24" fill="none" class="w-[18px] h-[18px]" aria-hidden="true">
            <path d="M4 4h7v7H4V4Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M13 4h7v7h-7V4Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M4 13h7v7H4v-7Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M13 13h7v7h-7v-7Z" stroke="currentColor" stroke-width="2"></path>
          </svg>
        </button>
        <button
          type="button"
          class="toggle-btn p-1.5 rounded text-slate-500 hover:text-slate-700 transition-colors cursor-pointer [&.active]:bg-white [&.active]:shadow-sm [&.active]:text-indigo-600"
          data-view="list"
          aria-label="列表"
          title="列表"
        >
          <svg viewBox="0 0 24 24" fill="none" class="w-[18px] h-[18px]" aria-hidden="true">
            <path d="M8 6h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M8 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M3 6h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
            <path d="M3 12h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
            <path d="M3 18h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
          </svg>
        </button>
      </div>

      <a
        href="/ingest"
        class="hidden sm:inline-flex items-center px-3 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"
      >入库</a>
    </div>
  </div>

  <div
    class="flex flex-col md:flex-row md:items-center gap-3 justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-200"
    data-bulk-controls
  >
    <div class="flex items-center gap-3 text-sm">
      <span class="font-medium text-slate-800">毗连设置</span>
      <span class="text-slate-500">已选 <span data-selected-count>0</span> 本</span>
      <button
        type="button"
        data-bulk-mode-toggle
        class="h-9 px-3 inline-flex items-center justify-center text-xs font-medium border border-slate-200 rounded-lg bg-white text-slate-700 hover:bg-slate-50 transition-colors cursor-pointer"
      >进入多选</button>
    </div>
    <div data-bulk-actions class="hidden flex flex-wrap items-center gap-2">
      <button
        type="button"
        data-bulk-select-all
        class="h-9 px-3 inline-flex items-center justify-center text-xs font-medium border border-slate-200 rounded-lg bg-white text-slate-700 hover:bg-slate-50 transition-colors cursor-pointer"
      >全选当前页</button>
      <button
        type="button"
        data-bulk-clear
        class="h-9 px-3 inline-flex items-center justify-center text-xs font-medium border border-slate-200 rounded-lg bg-white text-slate-700 hover:bg-slate-50 transition-colors cursor-pointer"
      >清空</button>
      <form id="bulk-download-form" action="/books/download" method="post" target="bulk-download-target" class="m-0">
        <div data-book-ids></div>
        <button
          type="submit"
          data-bulk-download
          class="h-9 px-3 inline-flex items-center justify-center text-xs font-medium border border-slate-200 rounded-lg bg-white text-slate-700 hover:bg-slate-50 transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >批量下载</button>
      </form>
      <form id="bulk-archive-form" action="/books/archive" method="post" class="m-0">
        <div data-book-ids></div>
        <button
          type="submit"
          data-bulk-archive
          class="h-9 px-3 inline-flex items-center justify-center text-xs font-medium border border-red-200 rounded-lg bg-white text-red-600 hover:bg-red-50 transition-colors cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >批量归档</button>
      </form>
    </div>
  </div>
  <iframe name="bulk-download-target" class="hidden"></iframe>

  {% include "partials/library_section.html" %}
</div>

<script>
  (() => {
    const viewToggle = document.querySelector('[data-view-toggle]');
    const selectedCount = document.querySelector('[data-selected-count]');
    const selectAllBtn = document.querySelector('[data-bulk-select-all]');
    const clearBtn = document.querySelector('[data-bulk-clear]');
    const bulkDownloadBtn = document.querySelector('[data-bulk-download]');
    const bulkArchiveBtn = document.querySelector('[data-bulk-archive]');
    const bulkDownloadForm = document.getElementById('bulk-download-form');
    const bulkArchiveForm = document.getElementById('bulk-archive-form');
    const pageInput = document.querySelector('[data-page-input]');
    const perPageInput = document.querySelector('[data-per-page-input]');
    const readFilterInput = document.querySelector('#library-controls input[name="read_filter"]');
    const readFilterToggle = document.querySelector('[data-read-filter-toggle]');
    const bulkModeToggleBtn = document.querySelector('[data-bulk-mode-toggle]');
    const bulkActions = document.querySelector('[data-bulk-actions]');
    const selectedBookIds = new Set();
    const mobileMediaQuery = window.matchMedia('(max-width: 767px)');
    const isMobileViewport = () => mobileMediaQuery.matches;
    let currentView = isMobileViewport() ? 'list' : (localStorage.getItem('bindery-view') || 'grid');
    let multiSelectMode = false;
    const GRID_ROWS_PER_PAGE = 4;

    function getLibrary() {
      return document.getElementById('library');
    }

    function syncPageInputFromSection() {
      if (!pageInput) return;
      const section = document.getElementById('library-section');
      if (!section) return;
      const page = (section.dataset.page || '').trim();
      if (page) pageInput.value = page;
    }

    function updateReadFilterLink() {
      if (!readFilterToggle) return;
      const params = new URLSearchParams();
      params.set('sort', sortSelect ? sortSelect.value : 'updated');
      params.set('q', searchInput ? searchInput.value : '');
      params.set('read_filter', readFilterInput && readFilterInput.value === 'unread' ? 'all' : 'unread');
      if (perPageInput && perPageInput.value) params.set('per_page', perPageInput.value);
      readFilterToggle.setAttribute('href', `/?${params.toString()}`);
    }

    function computeGridColumnCount() {
      const library = getLibrary();
      if (!library) return 0;
      const computed = window.getComputedStyle(library);
      const template = (computed.gridTemplateColumns || '').trim();
      const gap = Number.parseFloat(computed.columnGap || computed.gap || '20') || 20;
      const width = library.clientWidth || 0;
      let columns = 0;
      if (template && template !== 'none') {
        columns = template.split(/\s+/).filter(Boolean).length;
      }
      if (columns <= 0 && width > 0) {
        columns = Math.max(1, Math.floor((width + gap) / (180 + gap)));
      }
      return Math.max(1, columns);
    }

    function syncPerPageForGrid() {
      if (!perPageInput) return false;
      const columns = computeGridColumnCount();
      const next = Math.max(4, columns * GRID_ROWS_PER_PAGE);
      if (String(next) === String(perPageInput.value || '')) return false;
      perPageInput.value = String(next);
      updateReadFilterLink();
      return true;
    }

    function refreshLibraryByControls(pageValue = '1') {
      if (!window.htmx) return;
      const values = {
        sort: sortSelect ? sortSelect.value : 'updated',
        q: searchInput ? searchInput.value : '',
        read_filter: readFilterInput ? readFilterInput.value : 'all',
        page: String(pageValue),
      };
      if (perPageInput && perPageInput.value) values.per_page = perPageInput.value;
      window.htmx.ajax('GET', '/library', {
        target: '#library-section',
        swap: 'outerHTML',
        values,
      });
    }

    function applyLibraryView(view) {
      const library = getLibrary();
      if (!library) return;
      currentView = isMobileViewport() ? 'list' : (view || 'grid');
      library.dataset.view = currentView;
      library.querySelectorAll('[data-book-layout]').forEach((node) => {
        const layout = node.dataset.bookLayout;
        if (layout === 'grid') node.classList.toggle('hidden', currentView === 'list');
        if (layout === 'list') node.classList.toggle('hidden', currentView !== 'list');
      });
      hydrateCoverImages(currentView);
    }

    function syncViewportPreferredView() {
      if (isMobileViewport()) {
        applyLibraryView('list');
        return;
      }
      const preferred = localStorage.getItem('bindery-view') || currentView || 'grid';
      applyLibraryView(preferred);
    }

    function hydrateCoverImages(view) {
      const library = getLibrary();
      if (!library) return;
      library.querySelectorAll(`[data-book-layout="${view}"] img[data-cover-src]`).forEach((img) => {
        const source = img.dataset.coverSrc;
        if (!source || img.getAttribute('src')) return;
        img.setAttribute('src', source);
      });
    }

    function listVisibleBookIds() {
      const library = getLibrary();
      if (!library) return [];
      const ids = new Set();
      library.querySelectorAll('[data-book-select]').forEach((node) => {
        const bookId = (node.value || '').trim();
        if (bookId) ids.add(bookId);
      });
      return Array.from(ids);
    }

    function syncCheckboxes() {
      const library = getLibrary();
      if (!library) return;
      library.querySelectorAll('[data-book-select]').forEach((node) => {
        node.checked = selectedBookIds.has(node.value);
      });
    }

    function syncHiddenIds(form) {
      if (!form) return;
      const holder = form.querySelector('[data-book-ids]');
      if (!holder) return;
      holder.innerHTML = '';
      Array.from(selectedBookIds).forEach((bookId) => {
        const field = document.createElement('input');
        field.type = 'hidden';
        field.name = 'book_ids';
        field.value = bookId;
        holder.appendChild(field);
      });
    }

    function syncBulkUi() {
      const visibleIds = new Set(listVisibleBookIds());
      Array.from(selectedBookIds).forEach((bookId) => {
        if (!visibleIds.has(bookId)) selectedBookIds.delete(bookId);
      });
      syncCheckboxes();
      syncHiddenIds(bulkDownloadForm);
      syncHiddenIds(bulkArchiveForm);
      const count = selectedBookIds.size;
      if (selectedCount) selectedCount.textContent = String(count);
      const disabled = count === 0 || !multiSelectMode;
      if (bulkDownloadBtn) bulkDownloadBtn.disabled = disabled;
      if (bulkArchiveBtn) bulkArchiveBtn.disabled = disabled;
    }

    function applyMultiSelectMode(enabled) {
      multiSelectMode = Boolean(enabled);
      const library = getLibrary();
      if (library) {
        library.querySelectorAll('[data-book-select-wrap]').forEach((node) => {
          node.classList.toggle('hidden', !multiSelectMode);
        });
      }
      if (bulkActions) bulkActions.classList.toggle('hidden', !multiSelectMode);
      if (bulkModeToggleBtn) {
        bulkModeToggleBtn.textContent = multiSelectMode ? '退出多选' : '进入多选';
      }
      if (!multiSelectMode) {
        selectedBookIds.clear();
      }
      syncBulkUi();
    }

    if (viewToggle) {
      applyLibraryView(currentView);
      viewToggle.querySelectorAll('.toggle-btn').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.view === currentView);
        btn.addEventListener('click', () => {
          if (isMobileViewport()) return;
          const view = btn.dataset.view || 'grid';
          applyLibraryView(view);
          localStorage.setItem('bindery-view', view);
          viewToggle.querySelectorAll('.toggle-btn').forEach((node) => {
            node.classList.toggle('active', node.dataset.view === view);
          });
        });
      });
    }

    document.body.addEventListener('change', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement) || !target.matches('[data-book-select]')) return;
      if (!multiSelectMode) return;
      const bookId = (target.value || '').trim();
      if (!bookId) return;
      if (target.checked) selectedBookIds.add(bookId);
      else selectedBookIds.delete(bookId);
      syncBulkUi();
    });

    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        if (!multiSelectMode) return;
        listVisibleBookIds().forEach((bookId) => selectedBookIds.add(bookId));
        syncBulkUi();
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (!multiSelectMode) return;
        selectedBookIds.clear();
        syncBulkUi();
      });
    }

    if (bulkDownloadForm) {
      bulkDownloadForm.addEventListener('submit', (event) => {
        if (!multiSelectMode || selectedBookIds.size === 0) event.preventDefault();
      });
    }

    if (bulkArchiveForm) {
      bulkArchiveForm.addEventListener('submit', (event) => {
        if (!multiSelectMode || selectedBookIds.size === 0) event.preventDefault();
      });
    }

    if (bulkModeToggleBtn) {
      bulkModeToggleBtn.addEventListener('click', () => {
        applyMultiSelectMode(!multiSelectMode);
      });
    }

    const searchInput = document.querySelector('#library-controls input[name="q"]');
    const sortSelect = document.querySelector('#library-controls select[name="sort"]');
    if (searchInput && pageInput) {
      searchInput.addEventListener('input', () => {
        pageInput.value = '1';
        updateReadFilterLink();
      });
    }
    if (sortSelect && pageInput) {
      sortSelect.addEventListener('change', () => {
        pageInput.value = '1';
        updateReadFilterLink();
      });
    }

    let resizeTimer = null;
    window.addEventListener('resize', () => {
      if (isMobileViewport()) {
        if (currentView !== 'list') {
          applyLibraryView('list');
          syncBulkUi();
        }
        return;
      }
      if (currentView !== 'grid') return;
      if (resizeTimer) window.clearTimeout(resizeTimer);
      resizeTimer = window.setTimeout(() => {
        if (syncPerPageForGrid()) {
          if (pageInput) pageInput.value = '1';
          refreshLibraryByControls('1');
        }
      }, 180);
    });

    const onViewportChange = () => {
      syncViewportPreferredView();
      if (viewToggle) {
        viewToggle.querySelectorAll('.toggle-btn').forEach((node) => {
          node.classList.toggle('active', node.dataset.view === currentView);
        });
      }
      syncBulkUi();
    };
    if (typeof mobileMediaQuery.addEventListener === 'function') {
      mobileMediaQuery.addEventListener('change', onViewportChange);
    } else if (typeof mobileMediaQuery.addListener === 'function') {
      mobileMediaQuery.addListener(onViewportChange);
    }

    document.body.addEventListener('htmx:afterSwap', (event) => {
      if (event.target && event.target.id === 'library-section') {
        syncPageInputFromSection();
        applyLibraryView(currentView);
        syncPerPageForGrid();
        applyMultiSelectMode(multiSelectMode);
        syncBulkUi();
      }
    });

    syncPageInputFromSection();
    updateReadFilterLink();
    applyMultiSelectMode(false);
    syncViewportPreferredView();
    if (currentView === 'grid' && syncPerPageForGrid()) {
      if (pageInput) pageInput.value = '1';
      refreshLibraryByControls('1');
      return;
    }
    syncBulkUi();
  })();
</script>
{% endblock %}
