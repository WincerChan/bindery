{% extends "base.html" %}

{% block title %}Bindery · 书库{% endblock %}

{% block content %}
<div class="space-y-6">
  <div
    id="library-controls"
    class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200"
  >
    <div class="relative w-full md:w-96">
      <svg viewBox="0 0 24 24" fill="none" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" aria-hidden="true">
        <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"></path>
        <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
      </svg>
      <input
        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
        type="search"
        name="q"
        placeholder="搜索标题、作者…"
        value="{{ q }}"
        hx-get="/library"
        hx-target="#library"
        hx-trigger="keyup changed delay:400ms"
        hx-include="#library-controls"
      />
    </div>

    <div class="flex items-center gap-3 w-full md:w-auto">
      <select
        class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none"
        name="sort"
        hx-get="/library"
        hx-target="#library"
        hx-trigger="change"
        hx-include="#library-controls"
      >
        <option value="created" {% if sort == 'created' %}selected{% endif %}>最近导入</option>
        <option value="updated" {% if sort == 'updated' %}selected{% endif %}>最近修改</option>
      </select>

      <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200" data-view-toggle>
        <button
          type="button"
          class="toggle-btn p-1.5 rounded text-slate-500 hover:text-slate-700 transition-colors [&.active]:bg-white [&.active]:shadow-sm [&.active]:text-indigo-600"
          data-view="grid"
          aria-label="封面墙"
          title="封面墙"
        >
          <svg viewBox="0 0 24 24" fill="none" class="w-[18px] h-[18px]" aria-hidden="true">
            <path d="M4 4h7v7H4V4Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M13 4h7v7h-7V4Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M4 13h7v7H4v-7Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M13 13h7v7h-7v-7Z" stroke="currentColor" stroke-width="2"></path>
          </svg>
        </button>
        <button
          type="button"
          class="toggle-btn p-1.5 rounded text-slate-500 hover:text-slate-700 transition-colors [&.active]:bg-white [&.active]:shadow-sm [&.active]:text-indigo-600"
          data-view="list"
          aria-label="列表"
          title="列表"
        >
          <svg viewBox="0 0 24 24" fill="none" class="w-[18px] h-[18px]" aria-hidden="true">
            <path d="M8 6h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M8 12h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            <path d="M3 6h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
            <path d="M3 12h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
            <path d="M3 18h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
          </svg>
        </button>
      </div>

      <a
        href="/ingest"
        class="hidden sm:inline-flex items-center px-3 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 transition-colors"
      >入库</a>
    </div>
  </div>

  <div class="text-sm text-slate-500 flex items-center justify-between">
    <div>已入库 {{ books | length }} 本</div>
    <div class="text-xs font-mono text-slate-400">/library</div>
  </div>

  <div
    id="library"
    data-view="grid"
    class="grid gap-5 data-[view=grid]:grid-cols-2 sm:data-[view=grid]:grid-cols-3 md:data-[view=grid]:grid-cols-4 lg:data-[view=grid]:grid-cols-5 xl:data-[view=grid]:grid-cols-6 data-[view=list]:grid-cols-1"
  >
    {% include "partials/library.html" %}
  </div>
</div>

<script>
  const viewToggle = document.querySelector('[data-view-toggle]');
  const library = document.getElementById('library');
  if (viewToggle && library) {
    const stored = localStorage.getItem('bindery-view') || 'grid';
    library.dataset.view = stored;
    viewToggle.querySelectorAll('.toggle-btn').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.view === stored);
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        library.dataset.view = view;
        localStorage.setItem('bindery-view', view);
        viewToggle.querySelectorAll('.toggle-btn').forEach((b) => b.classList.toggle('active', b.dataset.view === view));
      });
    });
  }
</script>
{% endblock %}
