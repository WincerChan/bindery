{% extends "base.html" %}

{% block title %}阅读追踪 · Bindery{% endblock %}

{% block content %}
<div class="space-y-6">
  <section class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
    <form action="/tracker" method="get" class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto flex-1">
        <div class="relative w-full md:w-64">
          <svg viewBox="0 0 24 24" fill="none" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-[18px] h-[18px]" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
          </svg>
          <input
            type="search"
            name="q"
            value="{{ q }}"
            placeholder="Search title, author, tag..."
            class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>

        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
          <select
            name="read_filter"
            class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[120px]"
          >
            <option value="all" {% if read_filter == 'all' %}selected{% endif %}>阅读状态: 全部</option>
            <option value="unread" {% if read_filter == 'unread' %}selected{% endif %}>未读</option>
            <option value="reading" {% if read_filter == 'reading' %}selected{% endif %}>在读</option>
            <option value="read" {% if read_filter == 'read' %}selected{% endif %}>已读</option>
          </select>

          <select
            name="library_filter"
            class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[120px]"
          >
            <option value="all" {% if library_filter == 'all' %}selected{% endif %}>入库: 全部</option>
            <option value="in_library" {% if library_filter == 'in' %}selected{% endif %}>已入库</option>
            <option value="not_in_library" {% if library_filter == 'out' %}selected{% endif %}>未入库</option>
          </select>

          <select
            name="book_status_filter"
            class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[120px]"
          >
            <option value="all" {% if book_status_filter == 'all' %}selected{% endif %}>连载: 全部</option>
            <option value="ongoing" {% if book_status_filter == 'ongoing' %}selected{% endif %}>更新中</option>
            <option value="completed" {% if book_status_filter == 'completed' %}selected{% endif %}>已完结</option>
            <option value="hiatus" {% if book_status_filter == 'hiatus' %}selected{% endif %}>已断更</option>
          </select>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a
          href="/tracker"
          class="h-10 px-3 inline-flex items-center justify-center rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors whitespace-nowrap"
        >Clear</a>
        <button
          type="submit"
          class="h-10 px-4 rounded-lg font-medium border border-indigo-600 text-indigo-700 hover:bg-indigo-50 transition-colors whitespace-nowrap"
        >Filter</button>
        <button
          type="button"
          data-open-add-modal
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors whitespace-nowrap"
        >
          <span class="text-base leading-none">+</span>
          <span>Add Book</span>
        </button>
      </div>
    </form>

    <div class="mt-3 text-xs text-slate-500">
      当前显示 {{ stats.filtered }} / {{ stats.total }} · 已读 {{ stats.read }} · 在读 {{ stats.reading }} · 未读 {{ stats.unread }} · 已入库 {{ stats.in_library }}
    </div>
    {% if duplicate_notice %}
      <div class="mt-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-md px-3 py-2">
        已存在追踪条目：{{ duplicate_notice.title }}{% if duplicate_notice.author %} - {{ duplicate_notice.author }}{% endif %}，
        <button
          type="button"
          data-open-edit-from-notice
          data-wish-id="{{ duplicate_notice.id }}"
          data-source-id="wish-edit-data-duplicate-notice"
          class="underline underline-offset-2 text-amber-800 hover:text-amber-900"
        >点此前往编辑该条目。</button>
      </div>
      <form id="wish-edit-data-duplicate-notice" class="hidden" aria-hidden="true">
        <input type="hidden" name="title" value="{{ duplicate_notice.title }}" />
        <input type="hidden" name="author" value="{{ duplicate_notice.author or '' }}" />
        <input type="hidden" name="library_book_id" value="{{ duplicate_notice.library_book_id or '' }}" />
        <input type="hidden" name="tags" value="{{ duplicate_notice.tags_text or '' }}" />
        <input type="hidden" name="rating" value="{{ duplicate_notice.rating if duplicate_notice.rating is not none else '' }}" />
        <input type="hidden" name="read_status" value="{{ duplicate_notice.read_status or 'unread' }}" />
        <input type="hidden" name="book_status" value="{{ duplicate_notice.book_status or 'completed' }}" />
        <textarea name="comment">{{ duplicate_notice.comment or '' }}</textarea>
      </form>
    {% endif %}
  </section>

  <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="overflow-x-auto">
    <table class="min-w-[900px] w-full text-left border-collapse">
      <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold">
        <tr>
          <th class="px-4 py-3 whitespace-nowrap" style="width: 15em;">书名</th>
          <th class="px-4 py-3 whitespace-nowrap" style="width: 10em;">作者</th>
          <th class="px-4 py-3 whitespace-nowrap">状态</th>
          <th class="px-4 py-3 whitespace-nowrap">评分</th>
          <th class="px-4 py-3 whitespace-nowrap">阅读</th>
          <th class="px-4 py-3 whitespace-nowrap">更新时间</th>
          <th class="px-4 py-3 text-right whitespace-nowrap">操作</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for wish in wishes %}
          <tr id="wish-row-{{ wish.id }}" class="hover:bg-slate-50/50 transition-colors">
            <td class="px-4 py-2 text-base font-medium text-slate-900 leading-6">
              <div class="flex items-start gap-1" style="max-width: 15em;">
                <span class="block min-w-0 flex-1 truncate" title="{{ wish.title }}">{{ wish.title }}</span>
                {% if wish.exists_in_library and wish.library_book_id %}
                  <a
                    href="/book/{{ wish.library_book_id }}?return_to={{ current_url|urlencode }}"
                    aria-label="查看详情"
                    title="查看详情"
                    class="inline-flex items-center justify-center text-indigo-500 rounded-md p-1 hover:bg-indigo-100 hover:text-indigo-700 transition-colors"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="1.6em" height="1.6em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M7 17L17 7"></path>
                      <path d="M9 7h8v8"></path>
                    </svg>
                  </a>
                {% endif %}
              </div>
            </td>
            <td class="px-4 py-2 text-base text-slate-600 leading-6">
              <span class="block truncate whitespace-nowrap" style="max-width: 10em;" title="{{ wish.author or '—' }}">{{ wish.author or "—" }}</span>
            </td>
            <td class="px-4 py-2 leading-6 whitespace-nowrap">
              <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded border {{ wish.book_status_class }}">{{ wish.book_status_label }}</span>
            </td>
            <td class="px-4 py-2 text-sm text-slate-600 leading-6 whitespace-nowrap">
              {% if wish.rating is none %}
                <span class="text-slate-400">未评分</span>
              {% else %}
                <span>{{ wish.rating }} / 5</span>
              {% endif %}
            </td>
            <td class="px-4 py-2 text-sm leading-6 whitespace-nowrap">
              <span class="{{ wish.read_status_class }}">{{ wish.read_status_label }}</span>
            </td>
            <td class="px-4 py-2 text-sm text-slate-500 leading-6 whitespace-nowrap">{{ wish.updated_at_display }}</td>
            <td class="px-4 py-2 text-right whitespace-nowrap">
              <div class="inline-flex items-center gap-2">
                <button
                  type="button"
                  data-open-edit-modal
                  data-wish-id="{{ wish.id }}"
                  data-source-id="wish-edit-data-{{ wish.id }}"
                  class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition-colors text-sm"
                >编辑</button>
                <form action="/tracker/{{ wish.id }}/delete" method="post" class="m-0" onsubmit="return confirm('确定删除该记录？');">
                  <input type="hidden" name="next" value="{{ current_url }}" />
                  <button
                    type="submit"
                    class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-red-200 bg-white text-red-600 hover:bg-red-50 transition-colors text-sm"
                  >删除</button>
                </form>
              </div>
              <form id="wish-edit-data-{{ wish.id }}" class="hidden" aria-hidden="true">
                <input type="hidden" name="title" value="{{ wish.title }}" />
                <input type="hidden" name="author" value="{{ wish.author or '' }}" />
                <input type="hidden" name="library_book_id" value="{{ wish.library_book_id or '' }}" />
                <input type="hidden" name="tags" value="{{ wish.tags_text }}" />
                <input type="hidden" name="rating" value="{{ wish.rating if wish.rating is not none else '' }}" />
                <input type="hidden" name="read_status" value="{{ wish.read_status }}" />
                <input type="hidden" name="book_status" value="{{ wish.book_status }}" />
                <textarea name="comment">{{ wish.comment or '' }}</textarea>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-slate-400">
              <div class="text-sm">No books match your filters.</div>
              <a href="/tracker" class="text-indigo-600 text-sm font-medium mt-2 hover:underline inline-block">Clear all filters</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    <div class="border-t border-slate-200 px-4 py-3 flex items-center justify-between text-sm">
      <div class="text-slate-500">第 {{ page }} / {{ total_pages }} 页</div>
      <div class="flex items-center gap-2">
        {% if has_prev %}
          <a href="{{ prev_page_url }}" class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">上一页</a>
        {% else %}
          <span class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-slate-100 bg-slate-50 text-slate-400">上一页</span>
        {% endif %}
        {% if has_next %}
          <a href="{{ next_page_url }}" class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">下一页</a>
        {% else %}
          <span class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-slate-100 bg-slate-50 text-slate-400">下一页</span>
        {% endif %}
      </div>
    </div>
  </section>

  <div data-edit-modal class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-slate-900">编辑追踪</h3>
        <button type="button" data-close-edit-modal class="text-slate-400 hover:text-slate-600 text-xl leading-none">×</button>
      </div>
      <form data-edit-form action="/tracker" method="post" class="space-y-4">
        <input type="hidden" name="next" value="{{ current_url }}" />
        <input type="hidden" name="library_book_id" value="" />
        <p data-edit-identity-note class="hidden text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-md px-3 py-2">
          已入库条目的书名/作者由书库元数据维护，请在书籍详情页修改。
        </p>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
          <input type="text" name="title" required class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Book Title" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Author</label>
          <input type="text" name="author" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Author Name" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Tags</label>
          <input type="text" name="tags" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="玄幻, 仙侠" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Comment</label>
          <textarea name="comment" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="评论"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
            <select name="book_status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
              <option value="ongoing">更新中</option>
              <option value="completed" selected>已完结</option>
              <option value="hiatus">已断更</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Rating</label>
            <select name="rating" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
              <option value="">Unrated</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">阅读状态</label>
          <select name="read_status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
            <option value="unread">未读</option>
            <option value="reading">在读</option>
            <option value="read">已读</option>
          </select>
        </div>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg mt-2">保存更改</button>
      </form>
    </div>
  </div>

  <div data-add-modal class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-slate-900">Add to Tracker</h3>
        <button type="button" data-close-add-modal class="text-slate-400 hover:text-slate-600 text-xl leading-none">×</button>
      </div>
      <form action="/tracker" method="post" class="space-y-4">
        <input type="hidden" name="next" value="{{ current_url }}" />
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
          <input type="text" name="title" required class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Book Title" />
          <div data-add-existing-list class="hidden mt-2 text-xs text-slate-500 space-y-1"></div>
          <p data-add-duplicate-hint class="hidden mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-md px-3 py-2"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Author</label>
          <input type="text" name="author" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Author Name" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Tags</label>
          <input type="text" name="tags" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="玄幻, 仙侠" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Comment</label>
          <textarea name="comment" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="评论"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
            <select name="book_status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
              <option value="ongoing">更新中</option>
              <option value="completed" selected>已完结</option>
              <option value="hiatus">已断更</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Rating</label>
            <select name="rating" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
              <option value="">Unrated</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">阅读状态</label>
          <select name="read_status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
            <option value="unread">未读</option>
            <option value="reading">在读</option>
            <option value="read">已读</option>
          </select>
        </div>
        <button type="submit" data-add-submit-btn class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed text-white font-medium py-2.5 rounded-lg mt-2">Save to Tracker</button>
      </form>
    </div>
  </div>
</div>

<script>
  (() => {
    const rootWindow = window;
    const supportsAbortController = typeof AbortController !== 'undefined';
    let listenerOptions = undefined;
    if (supportsAbortController) {
      if (rootWindow.__binderyTrackerUiAbortController instanceof AbortController) {
        rootWindow.__binderyTrackerUiAbortController.abort();
      }
      const listenerController = new AbortController();
      rootWindow.__binderyTrackerUiAbortController = listenerController;
      listenerOptions = { signal: listenerController.signal };
    }

    function bindEvent(target, type, handler) {
      if (!target || typeof target.addEventListener !== 'function') return;
      if (listenerOptions) {
        target.addEventListener(type, handler, listenerOptions);
        return;
      }
      target.addEventListener(type, handler);
    }

    function openModal(modal, onOpened) {
      if (!modal) return;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (typeof onOpened === 'function') onOpened();
    }

    function closeModal(modal) {
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    const addModal = document.querySelector('[data-add-modal]');
    const addOpenBtn = document.querySelector('[data-open-add-modal]');
    const addCloseBtns = document.querySelectorAll('[data-close-add-modal]');
    const duplicateNoticeOpenBtns = document.querySelectorAll('[data-open-edit-from-notice]');
    const addForm = addModal ? addModal.querySelector('form[action="/tracker"]') : null;
    const addTitleInput = addForm ? addForm.querySelector('input[name="title"]') : null;
    const addAuthorInput = addForm ? addForm.querySelector('input[name="author"]') : null;
    const addSubmitBtn = addForm ? addForm.querySelector('[data-add-submit-btn]') : null;
    const addExistingList = addModal ? addModal.querySelector('[data-add-existing-list]') : null;
    const addDuplicateHint = addModal ? addModal.querySelector('[data-add-duplicate-hint]') : null;
    let addDuplicateTimer = null;
    let addDuplicateRequestId = 0;

    function jumpToWishEditor(wishId) {
      const normalizedWishId = String(wishId || '').trim();
      if (!normalizedWishId) return;
      const row = document.getElementById(`wish-row-${normalizedWishId}`);
      if (row instanceof HTMLElement) {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      const editBtn = document.querySelector(
        `[data-open-edit-modal][data-wish-id="${normalizedWishId}"]`
      );
      if (editBtn instanceof HTMLElement) {
        closeModal(addModal);
        openEditModal(editBtn);
      }
    }

    function setAddDuplicateHint(payload) {
      if (!(addDuplicateHint instanceof HTMLElement)) return;
      addDuplicateHint.innerHTML = '';
      if (!payload || typeof payload !== 'object') {
        addDuplicateHint.classList.add('hidden');
        return;
      }
      const title = typeof payload.title === 'string' ? payload.title.trim() : '';
      const author = typeof payload.author === 'string' ? payload.author.trim() : '';
      const wishId = typeof payload.wishId === 'string' ? payload.wishId.trim() : '';
      if (!title || !wishId) {
        addDuplicateHint.classList.add('hidden');
        return;
      }
      const prefix = document.createTextNode(
        author ? `已存在追踪条目：${title} - ${author}，` : `已存在追踪条目：${title}，`
      );
      const jumpBtn = document.createElement('button');
      jumpBtn.type = 'button';
      jumpBtn.className = 'underline underline-offset-2 text-amber-800 hover:text-amber-900';
      jumpBtn.textContent = '点此前往编辑该条目。';
      bindEvent(jumpBtn, 'click', () => jumpToWishEditor(wishId));
      addDuplicateHint.append(prefix, jumpBtn);
      addDuplicateHint.classList.remove('hidden');
    }

    function renderAddExistingList(matches) {
      if (!(addExistingList instanceof HTMLElement)) return;
      const rows = Array.isArray(matches) ? matches : [];
      addExistingList.innerHTML = '';
      if (!rows.length) {
        addExistingList.classList.add('hidden');
        return;
      }
      const heading = document.createElement('p');
      heading.textContent = `已添加项目（共 ${rows.length} 条）：`;
      addExistingList.appendChild(heading);
      const list = document.createElement('ul');
      list.className = 'list-disc pl-4 space-y-0.5';
      rows.slice(0, 5).forEach((item) => {
        const wishId = typeof item.id === 'string' ? item.id.trim() : '';
        if (!wishId) return;
        const title = typeof item.title === 'string' && item.title.trim() ? item.title.trim() : '未命名';
        const author = typeof item.author === 'string' ? item.author.trim() : '';
        const row = document.createElement('li');
        const prefix = document.createTextNode(author ? `${title} - ${author}，` : `${title}，`);
        const jumpBtn = document.createElement('button');
        jumpBtn.type = 'button';
        jumpBtn.className = 'underline underline-offset-2 text-indigo-600 hover:text-indigo-800';
        jumpBtn.textContent = '点此前往编辑';
        bindEvent(jumpBtn, 'click', () => jumpToWishEditor(wishId));
        row.append(prefix, jumpBtn);
        list.appendChild(row);
      });
      addExistingList.appendChild(list);
      addExistingList.classList.remove('hidden');
    }

    function normalizeExistingMatch(item) {
      if (!item || typeof item !== 'object') return null;
      const rawId = typeof item.id === 'string' ? item.id.trim() : '';
      if (!rawId) return null;
      const rawTitle = typeof item.title === 'string' ? item.title.trim() : '';
      const rawAuthor = typeof item.author === 'string' ? item.author.trim() : '';
      const rawLibraryBookId = typeof item.library_book_id === 'string' ? item.library_book_id.trim() : '';
      return {
        id: rawId,
        title: rawTitle || '未命名',
        author: rawAuthor,
        library_book_id: rawLibraryBookId,
        in_library: Boolean(item.in_library || rawLibraryBookId),
        exact_author: Boolean(item.exact_author),
        blocking: Boolean(item.blocking),
      };
    }

    function mergeDuplicateSuggestions(exactMatches, suggestionMatches) {
      const merged = [];
      const seen = new Set();
      const pushUnique = (item) => {
        const normalized = normalizeExistingMatch(item);
        if (!normalized) return;
        if (seen.has(normalized.id)) return;
        seen.add(normalized.id);
        merged.push(normalized);
      };
      (Array.isArray(exactMatches) ? exactMatches : []).forEach(pushUnique);
      (Array.isArray(suggestionMatches) ? suggestionMatches : []).forEach(pushUnique);
      return merged.slice(0, 5);
    }

    function setAddDuplicateBlocked(blocked, payload) {
      if (addSubmitBtn instanceof HTMLButtonElement) {
        addSubmitBtn.disabled = blocked;
      }
      setAddDuplicateHint(blocked ? payload : null);
    }

    async function checkAddDuplicate() {
      const currentRequestId = ++addDuplicateRequestId;
      if (!(addTitleInput instanceof HTMLInputElement)) return;
      const title = addTitleInput.value.trim();
      if (!title) {
        renderAddExistingList([]);
        setAddDuplicateBlocked(false, null);
        return;
      }
      if (typeof fetch !== 'function') {
        renderAddExistingList([]);
        setAddDuplicateBlocked(false, null);
        return;
      }
      const author = addAuthorInput instanceof HTMLInputElement ? addAuthorInput.value.trim() : '';
      const params = new URLSearchParams({ title });
      if (author) params.set('author', author);
      try {
        const response = await fetch(`/tracker/duplicate-check?${params.toString()}`, {
          headers: { Accept: 'application/json' },
        });
        if (!response.ok) {
          if (currentRequestId === addDuplicateRequestId) setAddDuplicateBlocked(false, null);
          return;
        }
        const payload = await response.json();
        if (currentRequestId !== addDuplicateRequestId) return;
        const suggestionMatches = payload && Array.isArray(payload.matches) ? payload.matches : [];
        const exactMatches = payload && Array.isArray(payload.exact_matches) ? payload.exact_matches : [];
        const displayMatches = mergeDuplicateSuggestions(exactMatches, suggestionMatches);
        if (!payload || !payload.exists) {
          renderAddExistingList(displayMatches);
          setAddDuplicateBlocked(false, null);
          return;
        }
        renderAddExistingList([]);
        const firstBlocking = Array.isArray(payload.blocking_matches) && payload.blocking_matches.length > 0
          ? payload.blocking_matches[0]
          : null;
        const firstMatch = firstBlocking || (exactMatches.length > 0 ? exactMatches[0] : null) || (displayMatches.length > 0 ? displayMatches[0] : null);
        const matchTitle = firstMatch && typeof firstMatch.title === 'string' ? firstMatch.title : title;
        const matchAuthor = firstMatch && typeof firstMatch.author === 'string' ? firstMatch.author.trim() : '';
        const matchId = firstMatch && typeof firstMatch.id === 'string' ? firstMatch.id : '';
        setAddDuplicateBlocked(true, {
          title: matchTitle,
          author: matchAuthor,
          wishId: matchId,
        });
      } catch (_error) {
        if (currentRequestId === addDuplicateRequestId) {
          renderAddExistingList([]);
          setAddDuplicateBlocked(false, null);
        }
      }
    }

    function scheduleAddDuplicateCheck() {
      if (addDuplicateTimer !== null) clearTimeout(addDuplicateTimer);
      addDuplicateTimer = setTimeout(() => {
        void checkAddDuplicate();
      }, 180);
    }

    if (addForm instanceof HTMLFormElement) {
      bindEvent(addForm, 'submit', (event) => {
        if (addSubmitBtn instanceof HTMLButtonElement && addSubmitBtn.disabled) {
          event.preventDefault();
        }
      });
    }
    if (addTitleInput instanceof HTMLInputElement) {
      bindEvent(addTitleInput, 'input', scheduleAddDuplicateCheck);
    }
    if (addAuthorInput instanceof HTMLInputElement) {
      bindEvent(addAuthorInput, 'input', scheduleAddDuplicateCheck);
    }

    if (addOpenBtn && addModal) {
      bindEvent(addOpenBtn, 'click', () => {
        openModal(addModal, () => {
          renderAddExistingList([]);
          setAddDuplicateBlocked(false, null);
          addDuplicateRequestId += 1;
          const firstInput = addModal.querySelector('input[name="title"]');
          if (firstInput instanceof HTMLInputElement) firstInput.focus();
          scheduleAddDuplicateCheck();
        });
      });
      addCloseBtns.forEach((btn) => bindEvent(btn, 'click', () => closeModal(addModal)));
      bindEvent(addModal, 'click', (event) => {
        if (event.target === addModal) closeModal(addModal);
      });
    }

    const editModal = document.querySelector('[data-edit-modal]');
    const editForm = editModal ? editModal.querySelector('[data-edit-form]') : null;
    const editIdentityNote = editModal ? editModal.querySelector('[data-edit-identity-note]') : null;
    const editCloseBtns = document.querySelectorAll('[data-close-edit-modal]');
    const editOpenBtns = document.querySelectorAll('[data-open-edit-modal]');

    function setFormField(form, name, value) {
      if (!(form instanceof HTMLFormElement)) return;
      const field = form.elements.namedItem(name);
      if (field instanceof HTMLInputElement || field instanceof HTMLSelectElement || field instanceof HTMLTextAreaElement) {
        field.value = typeof value === 'string' ? value : '';
      }
    }

    function setFieldReadOnly(form, name, locked) {
      if (!(form instanceof HTMLFormElement)) return;
      const field = form.elements.namedItem(name);
      if (!(field instanceof HTMLInputElement || field instanceof HTMLTextAreaElement)) return;
      field.readOnly = locked;
      field.classList.toggle('bg-slate-50', locked);
      field.classList.toggle('text-slate-500', locked);
    }

    function setIdentityNoteVisible(visible) {
      if (!(editIdentityNote instanceof HTMLElement)) return;
      editIdentityNote.classList.toggle('hidden', !visible);
    }

    function openEditModal(button) {
      if (!(button instanceof HTMLElement)) return;
      if (!(editModal instanceof HTMLElement) || !(editForm instanceof HTMLFormElement)) return;
      const wishId = button.getAttribute('data-wish-id') || '';
      const sourceId = button.getAttribute('data-source-id') || '';
      const sourceForm = sourceId ? document.getElementById(sourceId) : null;
      if (!wishId || !(sourceForm instanceof HTMLFormElement)) return;

      const sourceData = new FormData(sourceForm);
      editForm.setAttribute('action', `/tracker/${wishId}/update`);
      setFormField(editForm, 'title', String(sourceData.get('title') || ''));
      setFormField(editForm, 'author', String(sourceData.get('author') || ''));
      setFormField(editForm, 'library_book_id', String(sourceData.get('library_book_id') || ''));
      setFormField(editForm, 'tags', String(sourceData.get('tags') || ''));
      setFormField(editForm, 'rating', String(sourceData.get('rating') || ''));
      setFormField(editForm, 'read_status', String(sourceData.get('read_status') || 'unread'));
      setFormField(editForm, 'book_status', String(sourceData.get('book_status') || 'completed'));
      setFormField(editForm, 'comment', String(sourceData.get('comment') || ''));
      const linkedBookId = String(sourceData.get('library_book_id') || '').trim();
      const lockIdentity = linkedBookId.length > 0;
      setFieldReadOnly(editForm, 'title', lockIdentity);
      setFieldReadOnly(editForm, 'author', lockIdentity);
      setIdentityNoteVisible(lockIdentity);
      openModal(editModal, () => {
        const firstInput = editForm.querySelector('input[name="title"]');
        if (firstInput instanceof HTMLInputElement) firstInput.focus();
      });
    }

    editOpenBtns.forEach((btn) => {
      bindEvent(btn, 'click', () => openEditModal(btn));
    });
    duplicateNoticeOpenBtns.forEach((btn) => {
      bindEvent(btn, 'click', () => {
        const sourceId = btn.getAttribute('data-source-id') || '';
        if (sourceId && document.getElementById(sourceId)) {
          openEditModal(btn);
          return;
        }
        const wishId = btn.getAttribute('data-wish-id') || '';
        jumpToWishEditor(wishId);
      });
    });
    editCloseBtns.forEach((btn) => bindEvent(btn, 'click', () => closeModal(editModal)));
    if (editModal) {
      bindEvent(editModal, 'click', (event) => {
        if (event.target === editModal) closeModal(editModal);
      });
    }

    bindEvent(document, 'keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeModal(addModal);
      closeModal(editModal);
    });
  })();
</script>
{% endblock %}
