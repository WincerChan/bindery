{% extends "base.html" %}

{% block title %}阅读追踪 · Bindery{% endblock %}

{% block content %}
<div class="space-y-6">
  <section class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
    <form action="/tracker" method="get" class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto flex-1">
        <div class="relative w-full md:w-64">
          <svg viewBox="0 0 24 24" fill="none" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-[18px] h-[18px]" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"></path>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
          </svg>
          <input
            type="search"
            name="q"
            value="{{ q }}"
            placeholder="Search title, author, tag..."
            class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>

        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
          <select
            name="read_filter"
            class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[120px]"
          >
            <option value="all" {% if read_filter == 'all' %}selected{% endif %}>阅读状态: 全部</option>
            <option value="unread" {% if read_filter == 'unread' %}selected{% endif %}>未读</option>
            <option value="reading" {% if read_filter == 'reading' %}selected{% endif %}>在读</option>
            <option value="read" {% if read_filter == 'read' %}selected{% endif %}>已读</option>
          </select>

          <select
            name="library_filter"
            class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[120px]"
          >
            <option value="all" {% if library_filter == 'all' %}selected{% endif %}>入库: 全部</option>
            <option value="in_library" {% if library_filter == 'in' %}selected{% endif %}>已入库</option>
            <option value="not_in_library" {% if library_filter == 'out' %}selected{% endif %}>未入库</option>
          </select>

          <select
            name="book_status_filter"
            class="px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[120px]"
          >
            <option value="all" {% if book_status_filter == 'all' %}selected{% endif %}>连载: 全部</option>
            <option value="ongoing" {% if book_status_filter == 'ongoing' %}selected{% endif %}>更新中</option>
            <option value="completed" {% if book_status_filter == 'completed' %}selected{% endif %}>已完结</option>
            <option value="hiatus" {% if book_status_filter == 'hiatus' %}selected{% endif %}>已断更</option>
          </select>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a
          href="/tracker"
          class="h-10 px-3 inline-flex items-center justify-center rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors whitespace-nowrap"
        >Clear</a>
        <button
          type="submit"
          class="h-10 px-4 rounded-lg font-medium border border-indigo-600 text-indigo-700 hover:bg-indigo-50 transition-colors whitespace-nowrap"
        >Filter</button>
        <button
          type="button"
          data-open-add-modal
          class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors whitespace-nowrap"
        >
          <span class="text-base leading-none">+</span>
          <span>Add Book</span>
        </button>
      </div>
    </form>

    <div class="mt-3 text-xs text-slate-500">
      当前显示 {{ stats.filtered }} / {{ stats.total }} · 已读 {{ stats.read }} · 在读 {{ stats.reading }} · 未读 {{ stats.unread }} · 已入库 {{ stats.in_library }}
    </div>
  </section>

  <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <table class="w-full text-left border-collapse">
      <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold">
        <tr>
          <th class="px-6 py-4 w-[34%]">Book Info</th>
          <th class="px-6 py-4">Status</th>
          <th class="px-6 py-4">Rating &amp; Progress</th>
          <th class="px-6 py-4">Library</th>
          <th class="px-6 py-4 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for wish in wishes %}
          {% set update_form_id = "wish-update-" ~ wish.id %}
          <tr class="hover:bg-slate-50/50 transition-colors">
            <td class="px-6 py-4 align-top">
              <form id="{{ update_form_id }}" action="/tracker/{{ wish.id }}/update" method="post"></form>
              <input form="{{ update_form_id }}" type="hidden" name="next" value="{{ current_url }}" />
              <input form="{{ update_form_id }}" type="hidden" name="library_book_id" value="{{ wish.library_book_id or '' }}" />
              <div class="space-y-2">
                <input
                  form="{{ update_form_id }}"
                  type="text"
                  name="title"
                  required
                  value="{{ wish.title }}"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 text-slate-900 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <input
                  form="{{ update_form_id }}"
                  type="text"
                  name="author"
                  value="{{ wish.author or '' }}"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="作者"
                />
                <input
                  form="{{ update_form_id }}"
                  type="text"
                  name="tags"
                  value="{{ wish.tags_text }}"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 text-xs text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="标签，逗号分隔"
                />
                <input
                  form="{{ update_form_id }}"
                  type="text"
                  name="review"
                  value="{{ wish.review or '' }}"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 text-xs text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="一句话评语"
                />
                <textarea
                  form="{{ update_form_id }}"
                  name="comment"
                  rows="2"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 text-xs text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="评论"
                >{{ wish.comment or '' }}</textarea>
                {% if wish.tags %}
                  <div class="flex flex-wrap gap-1.5 pt-0.5">
                    {% for tag in wish.tags %}
                      <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200">{{ tag }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </td>

            <td class="px-6 py-4 align-top">
              <div class="space-y-2">
                <span class="inline-flex px-2 py-1 text-xs font-medium rounded border {{ wish.book_status_class }}">{{ wish.book_status_label }}</span>
                <select
                  form="{{ update_form_id }}"
                  name="book_status"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 bg-white text-sm focus:outline-none"
                >
                  <option value="ongoing" {% if wish.book_status == 'ongoing' %}selected{% endif %}>更新中</option>
                  <option value="completed" {% if wish.book_status == 'completed' %}selected{% endif %}>已完结</option>
                  <option value="hiatus" {% if wish.book_status == 'hiatus' %}selected{% endif %}>已断更</option>
                </select>
              </div>
            </td>

            <td class="px-6 py-4 align-top">
              <div class="space-y-2">
                <div class="flex items-center gap-0.5 text-amber-400 text-sm">
                  {% set rating_value = wish.rating or 0 %}
                  {% for i in range(1, 6) %}
                    <span class="{{ 'text-amber-400' if i <= rating_value else 'text-slate-300' }}">★</span>
                  {% endfor %}
                </div>
                <select
                  form="{{ update_form_id }}"
                  name="rating"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 bg-white text-sm focus:outline-none"
                >
                  <option value="" {% if wish.rating is none %}selected{% endif %}>未评分</option>
                  {% for i in range(5, 0, -1) %}
                    <option value="{{ i }}" {% if wish.rating == i %}selected{% endif %}>{{ i }} 星</option>
                  {% endfor %}
                </select>
                <select
                  form="{{ update_form_id }}"
                  name="read_status"
                  class="w-full px-2.5 py-1.5 rounded-md border border-slate-200 bg-white text-sm focus:outline-none"
                >
                  <option value="unread" {% if wish.read_status == 'unread' %}selected{% endif %}>未读</option>
                  <option value="reading" {% if wish.read_status == 'reading' %}selected{% endif %}>在读</option>
                  <option value="read" {% if wish.read_status == 'read' %}selected{% endif %}>已读</option>
                </select>
                <div class="text-xs font-medium {{ wish.read_status_class }}">{{ wish.read_status_label }}</div>
              </div>
            </td>

            <td class="px-6 py-4 align-top">
              {% if wish.exists_in_library and wish.library_book_id %}
                <a
                  href="/book/{{ wish.library_book_id }}"
                  class="inline-flex text-xs items-center gap-1.5 text-indigo-600 hover:text-indigo-800 font-medium bg-indigo-50 px-2 py-1 rounded border border-indigo-100 transition-colors"
                >In Library</a>
              {% else %}
                <span class="text-xs text-slate-400 inline-flex items-center gap-1">Not Acquired</span>
              {% endif %}
            </td>

            <td class="px-6 py-4 text-right align-top">
              <div class="inline-flex items-center gap-2">
                <button
                  form="{{ update_form_id }}"
                  type="submit"
                  class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition-colors"
                >保存</button>
                <form action="/tracker/{{ wish.id }}/delete" method="post" class="m-0" onsubmit="return confirm('确定删除该记录？');">
                  <input type="hidden" name="next" value="{{ current_url }}" />
                  <button
                    type="submit"
                    class="h-8 px-3 inline-flex items-center justify-center rounded-md border border-red-200 bg-white text-red-600 hover:bg-red-50 transition-colors"
                  >删除</button>
                </form>
              </div>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" class="px-6 py-12 text-center text-slate-400">
              <div class="text-sm">No books match your filters.</div>
              <a href="/tracker" class="text-indigo-600 text-sm font-medium mt-2 hover:underline inline-block">Clear all filters</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <div data-add-modal class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-slate-900">Add to Tracker</h3>
        <button type="button" data-close-add-modal class="text-slate-400 hover:text-slate-600 text-xl leading-none">×</button>
      </div>
      <form action="/tracker" method="post" class="space-y-4">
        <input type="hidden" name="next" value="{{ current_url }}" />
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
          <input type="text" name="title" required class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Book Title" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Author</label>
          <input type="text" name="author" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Author Name" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Tags</label>
          <input type="text" name="tags" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="玄幻, 仙侠" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Review</label>
          <input type="text" name="review" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="一句话评语" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Comment</label>
          <textarea name="comment" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="评论"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
            <select name="book_status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
              <option value="ongoing">更新中</option>
              <option value="completed">已完结</option>
              <option value="hiatus">已断更</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Rating</label>
            <select name="rating" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
              <option value="">Unrated</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Read Status</label>
          <select name="read_status" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
            <option value="unread">Unread</option>
            <option value="reading">Reading</option>
            <option value="read">Read</option>
          </select>
        </div>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg mt-2">Save to Tracker</button>
      </form>
    </div>
  </div>
</div>

<script>
  (() => {
    const modal = document.querySelector('[data-add-modal]');
    const openBtn = document.querySelector('[data-open-add-modal]');
    const closeBtns = document.querySelectorAll('[data-close-add-modal]');

    if (!modal || !openBtn) return;

    function openModal() {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      const firstInput = modal.querySelector('input[name="title"]');
      if (firstInput instanceof HTMLInputElement) firstInput.focus();
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    openBtn.addEventListener('click', openModal);
    closeBtns.forEach((btn) => btn.addEventListener('click', closeModal));

    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') closeModal();
    });
  })();
</script>
{% endblock %}
